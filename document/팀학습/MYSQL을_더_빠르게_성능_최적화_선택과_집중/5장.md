# 5장 샤딩

데이터베이스 샤딩은 여러 데이터베이스에 워크로드를 분산하여 성능을 향상시키는 스케일아웃 기술로, 일반적이고 폭넓게 사용됩니다.  
샤드는 물리적으로 분리되어 있지만 논리적으로는 같은 데이터베이스입니다.  

샤딩은 MySQL의 고유한 기능이나 능력이 아니어서 엔지니어들이 받아들이기 싫어하는 기술 가운데 하나입니다.  


## 5-1 단일 데이터베이스를 확장하지 않는 이유

샤딩은 MySQL을 수평 확장하는 방식이므로 더 많은 데이터베이스가 필요합니다.  


### 애플리케이션 워크로드

쿼리와 데이터, 접근 패턴은 성능과 관련하여 뗄 수 없는 관계입니다.  
데이터 크기는 늘어날수록 쿼리와 접근 패턴에 영향을 줍니다.  

쿼리가 단순하고 인덱스가 매우 우수하며 접근 패턴이 단순하다면 단일 서버에 많은 데이터를 저장할 수 있습니다.  


### 모의 벤치마크

벤치마크는 모의 쿼리, 데이터, 접근 패턴을 사용합니다.  
따라서 벤치마크는 같은 하드웨어에서도 애플리케이션의 성능과 확장 방식을 알려주거나 제안할 수도 없습니다.  

대부분의 애플리케이션에는 하나 이상의 접근 패턴 때문에 성능이 좌우되는 워크로드를 가지고 있지 않습니다.  

벤치마크는 다음을 수행하는 데 사용 됩니다.  
- 하드웨어 비교
- 서버 최적화 비교: 플러싱 알고리즘을 다른 알고리즘과 비교
- 서로 다른 데이터 스토리지 비교
- MySQL 한계 테스트

벤치마크에서 확인한 놀라운 성능은 애플리케이션으로 변환되지 않습니다.  


### 쓰기

쓰기는 다음과 같은 이유로 단일 MySQL 인스턴스에서 확장하기 어렵습니다,  

#### 단일 쓰기 (원본) 인스턴스

동시에 같은 행에 여러 번 쓸 수 있는 쓰기 충돌을 피하기 위해 쓰기는 단일 MySQL 인스턴스로 제한됩니다.  

#### 트랜잭션과 잠금

트랜잭션은 ACID 호환 데이터베이스의 'C'와 같이 일관성을 보장하기 위해 잠금을 사용합니다.  
쓰기는 로우 락을 획득해야 하며 때로는 예상보다 훨씬 더 많은 행을 잠급니다.  
같은 데이터에 대해 쓰기 작업량이 많은 워크로드라면 세계 최고의 하드웨어로도 도움이 되지 않습니다.  

#### 페이지 플러싱(지속성)

페이지 플러싱은 MySQL이 디스크에서 변경 사항을 유지하는 지연된 프로세스입니다.  
중요한 점은 페이지 플러싱이 쓰기 성능의 병목 현상이라는 것입니다.  
디스크에 유지되는 지속성이 없다면 캐싱으로 인해 쓰기 속도가 매우 빨라지겠지만, 결국은 모든 하드웨어가 충돌하므로 지속성이 필요합니다.  

#### 쓰기 확대

쓰기 확대는 필요 이상의 부가적인 쓰기를 말합니다.  
테이블에 10개의 세컨더리 인덱스가 있을 때 단일 쓰기는 해당 인덱스를 갱신하기 위해 쓰기 작업을 10번 더 할 수 있습니다.  

> 레거시 테이블에 인덱스 추가가 쉽지 않았던 이유

#### 복제

고가용성을 위해서는 복제가 필요하므로 모든 쓰기 작업은 다른 MySQL 인스턴스로 복제해야 합니다.  
MySQL은 비동기 복제, 반동기 복제, 그룹 복제를 지원합니다.  

- 비동기 복제
  - 트랜잭션을 커밋할 때 데이터 변경 사항이 바이너리 로그에 기록되고 플러싱되므로 쓰기 성능에 약간의 영향이 있음
- 반동기 복제
  - 모든 커밋을 하나 이상의 복제본에서 인지해야 하므로 네트워크 대기 시간에 대한 트랜잭션 처리량을 떨어트림
  - 커밋된 트랜잭션이 손실되지 않도록 보장
- 그룹 복제
  - 더 복잡하고 쓰기를 확장하기가 더 어려움






