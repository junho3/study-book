# 11 자동 완성/타입어헤드

자동 완성 시스템은 전 세계 수십억 명의 사용자가 입력한 문자열에서 데이터를 수집하고 이 데이터를 가중 트라이로 처리한다.  
자동 완성 시스템에 개인화와 머신러닝 요소를 추가할 수도 있다.  

## 11.1 자동 완성의 가능한 사용 사례

- 각 키 입력마다 자동 완성 제안 목록을 반환한다. 사용자가 제안을 선택하면 검색 서비스가 이를 수락하고 결과 목록을 반환한다.
  - 구글
  - 위키피디아
- 워드 프로세서가 자동 완성 제안을 제공할 수 있다.
  - 퍼지 매칭
- 코딩용 통합 개발 환경(IDE)에 자동 완성 기능이 있을 수 있다.

각 사용 사례에 따라 자동 완성 서비스는 서로 다른 데이터 소스와 아키텍처를 사용한다.

면접관이 '구글과 같은 일반 검색 앱용 자동 완성을 제공하는 시스템을 설계하라'와 같은 구체적인 질문을 하더라도 잠깐 동안 자동 완성 기능의 다른 용도에 대해 논의할 수 있다.  
질문을 넘어서 생각할 수 있고 성급하게 가정하거나 결론을 내리지 않는다는 것을 보여준다.

> IDE의 AI 플러그인도 짧은 시간 내에 서버와 통신하여 코드를 자동 완성 시키는건지? 


## 11.2 검색 vs. 자동 완성

자동 완성과 검색을 구별하고 요구사항을 혼동하지 않아야 한다.  

- 검색
  - 몇 초의 P99 지연 시간 허용
  - 높은 정확도 요구
- 자동 완성
  - 100ms의 P99
  - 정확도가 검색만큼 높지 않음


## 11.3 기능 요구사항

### 11.3.1 자동 완성 서비스의 범위

먼저 지원해야 할 사용 사례와 언어 등 범위의 세부 사항을 명확히 한다.


### 11.3.2 UX 세부 사항

- 문장 단위인지 개별 단어 단위인지
- 몇 자를 입력해야 자동 완성 제안이 표시되는지


### 11.3.3 검색 기록 고려

- 현재 입력만을 기반으로 할지
- 검색 기록과 다른 데이터 소스를 기반으로 할지


### 11.3.4 콘텐츠 조정과 공정성

- 부적절한 제안을 신고할 수 있는지
- 검색 빈도별 가중치를 고려해야 하는지


## 11.4 비기능적 요구사항

- 글로벌 사용자 기반이 사용할 수 있게 확장 가능해야 함
- 중요한 기능이 아니므로 내결함성은 양보 가능
- 높은 성능과 처리량. 0.5초 내 제안을 볼 수 있어야 함
- 일관성은 필요 없음
- 프라이버시와 보안
- 정확도


## 11.5 상위 수준 아키텍처 계획

- 데이터 수집
- 데이터 처리
- 처리된 데이터를 쿼리해 자동 완성 추천을 얻음

데이터 처리는 일반적으로 수집보다 리소스 집약적이다.  
수집은 요청을 받아들이고 기록하기만 하면 되며 트래픽 급증을 처리해야 한다.  
따라서 확장성을 높이기 위해 데이터 처리 시스템과 수집 시스템을 분리했다.  


## 11.6 가중치 트라이(Trie) 접근법과 초기 고수준 아키텍처

- 검색 서비스
  - 사용자가 검색 문자열 제출
- 공유 로깅 서비스
  - 자동 완성 추천을 도출하는 원시 데이터 소스
  - 사용자의 검색 쿼리를 기록
- 단어 처리 ETL 작업
- 가중치 트라이 생성기
- 자동 완성 서비스
    - 사용자에게 자동 완성 쿼리 제공

자동 완성 추천은 가중치 트라이를 사용해 생성된다.  
`B:4, A:4, T:22, Y:44`가 있을 때 `ba`를 입력하면 가중치가 높은 `bay`, `bat` 순서로 정렬


## 11.7 상세 구현

가중치 트라이 생성기는 일일 배치 ETL 파이프라인이 될 수 있다.  

단어 처리 ETL 작업과 가중치 트라이 생성기가 별도의 파이프라인 단계로 되어 있는 이유는 단어 처리 ETL 작업이 다른 여러 목적과 서비스에 유용할 수 있고, 별도의 단계로 구성하면 각각을 독립적으로 구현, 테스트, 유지보수 및 확장할 수 있기 때문이다.  

- 로깅 서비스의 검색 토픽에서 관련 로그를 가져와 임시 저장소에 저장
- 검색 문자열을 단어로 분리
- 부적절한 단어를 걸러냄
- 단어 수를 세어 단어 수 테이블에 기록. 필요한 정확도에 따라 모든 단어를 세거나 카운트-민 스케치와 같은 근사 알고리즘 사용
- 적절한 단어를 필터링하고 잘 알려지지 않은 인기 단어 기록
- 단어 수 테이블에서 가중치 트라이 생성
- 가중치 트라이를 백엔드 호스트로 전송

각 단계에서 이전 단계의 데이터베이스 저장소에서 데이터를 읽고 처리한 다음, 다음 단계에서 사용할 데이터베이스 저장소에 기록한다.  


### 11.7.1 각 단계는 독립적인 작업이어야 한다.

가중치 트라이 생성을 단일 작업으로 구현하고 모든 함수를 연결할 수 있다.  
이러한 접근 방식은 간단하지만 유지보수가 어렵다.  

가중치 트라이 생성에서 오류가 발생해 프로세스가 중단되면 전체 프로세스를 처음부터 다시 시작해야 한다.  
이러한 ETL 작업은 계산 집약적이며 완료하기까지 몇 시간이 걸릴 수 있으므로 이러한 접근 방식은 성능이 낮다.  
이러한 단계를 별도의 작업으로 구현하고 에어플로와 같은 작업 스케줄러 시스템을 사용해 이전 작업이 성공적으로 완료된 후에만 각 작업이 실행되게 해야 한다.  


### 11.7.2 일래스틱서치에서 HDFS로 관련 로그 가져오기

이 스크립트는 각 플롯폼의 병렬 처리 기능을 활용해야 한다.  
또한 분할 전략을 설명할 수도 있다.  


### 11.7.3 검색 문자열을 단어 및 다른 간단한 연산으로 분할하기




