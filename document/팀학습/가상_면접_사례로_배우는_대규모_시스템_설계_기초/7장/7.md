# 7장 분산 시스템을 위한 유일 ID 생성기 설계

## 1단계 문제 이해 및 설계 범위 확정

질문을 할 때는 요구사항을 이해하고 모호함을 해소하는 데 초점을 맞추어야 한다.  

## 2단계 개략적 설계안 제시 및 동의 구하기

### 다중 마스터 복제

이 접근법은 데이터베이스의 auto_increment 기능을 활용하는 것이다.  
다만 다음 ID의 값을 구할 때 1만큼 증가시켜 얻는 것이 아니라, k(데이터베이스 서버의 수)만큼 증가시킨다.  

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
- ID의 유일성은 보장되겠지만 그 값이 시간 흐름에 맞추어 커지도록 보장할 수는 없다.
- 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어렵다.

### UUID

UUID는 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트짜리 수다.  
UUID 값은 충돌 가능성이 지극히 낮다.  

- UUID를 만드는 것은 단순하다.
- 서버 사이의 조율이 필요 없으므로 동기화 이슈도 없다.
- 각 서버가 자기가 쓸 ID를 알아서 만드는 구조이므로 규모 확장도 쉽다.

- ID가 128비트로 길다.
- ID를 시간순으로 정렬할 수 없다.
- ID에 숫자가 아닌 값이 포함될 수 있다.

> 광고 클릭수 노출수 집계를 위해 UUID 키를 활용한 적 있음  
> 광고 클릭수와 노출수는 고유해야함  
> 동일한 UUID가 들어오면 어뷰징으로 간주  

### 티켓 서버

이 아이디어의 핵심은 auto_increment 기능을 갖춘 데이터베이스 서버, 즉 티켓 서버를 중앙 집중형으로 하나만 사용하는 것이다.  

- 유일성이 보장되는 오직 숫자로만 구성된 ID를 쉽게 만들 수 있다.
- 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.
- 티켓 서버가 SPO가 된다.

> 주문번호(현재 결제번호) 채번할 때 Redis(티켓 서버)를 활용 중
> Y-m-d H:i로 구성된 키를 TTL 1분으로 설정하여 Redis에 올려두고, 키가 있으면 +1씩 증가시킴

### 트위터 스노플레이크 접근법

생성해야 하는 ID의 구조를 여러 절로 분할하는 것이다.  

- 사인 비트
- 타임스탬프
- 데이터센터 ID
- 서버 ID
- 일련번호

## 3단계 상세 설계

### 타임스탬프

### 일련번호

## 4단계 마무리

- 시계 동기화: ID 생성 서버들이 전부 같은 시계를 사용한다고 가정하였으나, 하나의 서버가 여러 코어에서 실행될 경우 유효하지 않을 수 있다.  

> 스케일 아웃으로 생성된 서버에서 시스템 시간이 맞지 않는 이슈를 발견 함  
> 서버가 올라올 때 시스템 시간을 셋팅하도록 설정한 것으로 기억
