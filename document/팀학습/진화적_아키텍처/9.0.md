# CHAPTER 9 아키텍처 실천

## 9.1 조직적 요인

### 9.1.1 콘웨이의 법칙

사회적 구조, 사람들 사이의 의사소통 경로가 최종 제품 설계에 필연적으로 영향을 미친다는 개념을 제시했다.  

콘웨이에 따르면 하나의 큰 문제를 작게 나누어 위임하면 각각을 조정하는 문제가 다시 발생한다.  
계층 아키텍처는 사용자 인터페이스, 비즈니스 로직 등의 기술적 기능을 기준으로 계층을 나눈다.  
그러나 이 구조에서 여러 계층을 수직으로 관통하는 공통 요건을 처리하면 오히려 조정 오버헤드가 증가한다.  

콘웨이는 소프트웨어 아키텍트가 아키텍처 설계 이외의 측면에 주의를 기울여야 한다고 강조하고 있다.  
위임, 할당, 팀 간 조정 등의 사안은 설계만큼이나 아키텍트에게 중요하다.  

콘웨이가 지적한 대로 위임 영역이 분할되고 담당 범위가 좁아질 때마다 효과적인 설계 대안은 줄어든다.  
바꿔 말하면, 누군가가 소유하고 있는 대상은 타인이 변경하기 매우 어렵다.  
그러므로, 소프트웨어 아키텍트는 작업을 분할하는 방식과 위임 범위를 항상 고민하고, 아키텍처의 목표와 팀 구조를 일치시키기 위해 노력해야 한다.  

마이크로서비스 아키텍처를 구축하는 회사는 대부분 기술적인 기준보다 서비스 경계를 기준으로 팀을 구성한다.  

도메인을 중심으로 구성된 팀은 기술 중심 팀보다 진화적 아키텍처를 구현하기 유리하다.  

> 안타깝지만 기존 조직 구성을 갈아엎는건 CEO급이 아니면 불가능하다고 생각 함  

#### 교차기능팀

도메인 중심 팀은 교차기능팀인 경우가 많다.  
즉, 한 팀의 구성원만으로 제품의 모든 영역을 아우를 수 있다.  
서비스 설계, 구현, 배포 등의 모든 역할을 하나의 팀이 담당하며, 운영처럼 전통적으로 분리되어 있던 역할까지 포괄한다.  

교차기능팀의 다양한 역할
- 아키텍처: 아키텍처는 증분 변경을 방해하는 부적절한 커플링을 제거해야 한다.  
- 비즈니스 분석가: 도메인 영역의 복잡도가 높은 제품은 비즈니스 규칙, 설정, 제품 이력 등의 특성도 복잡하다.  
- 데이터 
- 개발자: 개발자는 기존에 자신의 분야가 아니었던 작업도 처리할 수 있어야 한다.  
- 디자이너
- 운영
- 제품 관리자(PM)
- 테스트

교차기능팀의 목표 중 하나는 팀 조정 과정에서 발생하는 마찰을 근절하는 것이다.


##### 아마존의 피자 두 판 팀


#### 비즈니스 기능 중심 팀 구성

도메인을 중심으로 팀을 구성한다는 것은 비즈니스 기능을 중심으로 팀이 구성될 것임을 암시한다.  


#### 비즈니스 기능과 인지 부하의 균형

- 스트림 정렬팀: 비즈니스 도메인의 작업 흐름과 일치하는 팀
- 활성화팀: 새로운 기술/기법을 습득하도록 지원하는 팀
- 난해한 하위시스템팀: 비즈니스 도메인 중 수학/계산/기술 분야 담당
- 플랫폼팀: 스트림 정렬팀의 업무 속도를 가속시키기 위해 강력한 내부 도구를 생산하고 지원하는 팀  

팀을 설계할 때는 인지 부하를 반드시 함께 고려해야 한다.  


#### 프로젝트를 넘어 제품으로

> 카카오페이손해보험에 합류한 초반에는 드릴다운팀이 있었음  
> 비즈니스 개발을 위해 필요한 주제를 관심있는 사람 2~3명이 지원하여 POC를 담당  
> 취지는 좋지만 본업과 부업 사이에서 리소스 관리가 어렵고, 최종적으로 서비스를 인수인계 받는 팀에게는 낯선 개발(코드) 결과물을 받아야하는 문제가 있었음

따라서 개발자는 품질 지표에 주인의식을 느끼며 제품의 결함에 더욱 많은 관심을 기울인다.  

> 아직 팀을 리딩해본 경험은 없지만, 반드시 팀원이 하나의 서비스를 담당하는 분위기를 만들고자했음  
> 그것이 명목상일지라도 배포관리, 모니터링, 코드개선처럼 서비스에 대해 주인의식을 갖도록 하기 위함  


#### 과도한 팀 규모 지양

문제는 사람의 수가 아니라 사람들이 만들어내는 연결의 수다.  
폭증하는 의사소통 경로를 제한하려면 팀을 축소해야 하며, 축소된 팀은 교차기능팀이어야 한다.  


#### 팀 커플링 특성

팀 구조가 아키텍처 커플링 특성에 미치는 영향을 고려하지 않는 아키텍트가 많지만, 실제로는 막대한 영향을 미친다.  


### 9.1.2 문화

탁월한 아키텍트는 리더쉽을 발휘하며 기술 문화를 조성하고 개발자를 위해 시스템 구축 방식을 설계한다.  
또한 진화적 아키텍처 구축에 필요한 기술을 엔지니어에게 전수하고 장려한다.  

- 모든 팀 구성원이 피트니스 함수를 알고 있으며 새로운 도구나 제품이 피트니스 함수 제작 역량에 미치는 영향을 고려하고 있는가?  
- 피트니스 함수를 정의하고 시스템이 이를 얼마나 준수하고 있는지 측정하고 있는가?  
- 응집도, 커플링, 동조성을 엔지니어가 이해하고 있는가?
- 도메인과 어울리는 기술 개념에 대해 대화를 나누고 있는가?
- 배우고 싶은 기술이 아닌 변화에 적응하는 능력을 기준으로 솔루션을 선택하고 있는가?
- 비즈니스 변화에 팀은 어떻게 대응하고 있는가? 사소한 비즈니스 변화도 통합하기 어려워하거나 너무 많은 시간을 소비하고 있지는 않는가?

코드 리뷰는 현재의 코드가 향후 얼마나 변화에 잘 적응할지 자연스럽게 고민할 수 있는 지점이다.  

코드 품질과 진화성은 의식적으로 우선시하지 않는 한 간과될 가능성이 높다.  


### 9.1.3 실험 문화

조직은 다음과 같은 다양한 방법으로 실험을 장려할 수 있다.  
- 외부 아이디어 도입
- 명시적 개선 장려
- 스파이크 구현 및 안정화: 스파이크 솔루션의 목표는 우수한 설계가 아닌 빠른 학습 속도다.
- 혁신 시간 확보
- 집합 기반 개발: 효과적인 집합 기반 개발의 핵심은 짧은 시간동안 여러 방식으로 프로토타입을 제작하고 상세한 데이터와 경험을 얻는 것이다.
- 엔지니어와 최종 사용자 연결


### 9.1.4 CFO와 예산

아키텍처 퀀툼 수가 증가할 때 비용이 감소하는 이유는 다음과 같다.
1. 아키텍처를 구성하는 요소가 더 작아지므로 관심사가 더욱 명확하게 분리 및 정의된다.
2. 물리적인 퀀텀 수가 늘어나면 운영은 자동화로 대응해야 한다.

그러나 퀀텀이 지나치게 작아지면 퀀텀 수의 규모 자체가 비용을 유발하기 시작한다.  

공격적인 시장을 상대하는 기업은 기민하게 움직여야 하므로 작은 퀀텀이 적합하다.  
반대로, 단순함을 중요시하는 회사는 모놀리식 아키텍처를 구축하는 것이 더 실용적일 것이다.  


## 9.2 비즈니스 사례

아키텍트는 진화적 아키텍처가 불러올 변화와 함께 거버넌스 자동화에 대한 확신을 함께 심어줄 수 있어야 한다.  

아키텍트는 비즈니스 이해관계자가 이해하고 받아들일 수 있는 언어를 이용해 아키텍처의 개념을 설명할 수 있다.  


### 9.2.1 가설 주도 개발 및 데이터 주도 개발

데이터 주도 개발은 데이터를 중심으로 기술적 변화를 도모하는 개발 방법론이다.  
가설 주도 개발은 기술 측면의 관심사 대신 비즈니스를 통합한다.  

가설 주도 개발은 공식화된 요구 사항을 수집하고 애플리케이션 기능으로 구현하는 프로세스를 따르지 않는다.  
그 대신, 과학적인 방법론에 시간과 자원을 투입한다.  
먼저 실행 가능한 최소 제품 버전으로 애플리케이션을 만들고, 요구 사항이 아닌 가설에 근거해 새로운 기능을 추가한다.  

애자일 소프트웨어 방법론을 가동하는 엔진은 중첩된 피드백 순환이다.  
이러한 피드백은 테스트, 지속적 통합, 반복 수행을 통해 형성된다.  


### 9.2.2 실험적 매체로서의 피트니스 함수

#### 사례연구1 UDP 통신

피트니스 함수 실행 후, 메시지의 40%가 대규모로 손실되고 있음이 밝혀졌다.  

#### 사례연구2 보안 의존성

#### 사례연구3 동시 피트니스 함수

피트니스 함수를 실행한 결과, 평균 호출 건수가 초당 1,200건으로 예상을 크게 초과했음을 알게 되었다.  
따라서 팀은 확장 임계치를 현실적인 수준으로 갱신했다.  

#### 사례연구4 정확성 피트니스 함수

두 버전의 코드를 일정 비율에 따라 나란히 실행하며 차이점을 비교하고, 신기능이 구기능과 동일하게 작동하는지 검증한다.  

피트니스 함수가 낳은 또 다른 부수적인 효과가 있다.  
그간 명시되지 않았던 일부 유형의 데이터가 피트니스 함수를 통해 식별되었으며, 이를 통해 레거시 시스템의 데이터 의존성에 대한 전체적인 이해도를 높일 수 있었다.  


## 9.3 엔터프라이즈 피트니스 함수 구축

진화적 아키텍처에서 엔터프라이즈 아키텍트의 역할은 엔터프라이즈 피트니스 함수와 관련 지침을 중심으로 이루어진다.  
아키텍트는 아키텍처와 플랫폼이 생성하는 커플링 지점에 대한 지침을 제공해야 한다.  


### 9.3.1 사례연구 제로데이 보안 취약점

네트워크 패킷 수준에서 알려진 취약점을 검색하는 스캐닝 도구는 많다.  
그러나 정확한 시점에 원하는 취약점을 테스트할 수 있는 도구는 많지 않다.  

각 팀의 배포 파이프라인은 슬롯이 있으며, 보안팀은 이곳을 통해 피트니스 함수를 배포할 수 있다.  
이를테면 데이터베이스에 암호를 저장하지 못하도록 방지하는 작업과 비슷하다.  
보안팀은 특정 프레임워크나 버전 번호를 확인하는 테스트를 모든 프로젝트에 삽입할 수 있으며, 테스트 도중 취약한 버전이 발견되면 빌드를 중단하고 원인을 파악할 수 있다.  
다행히도, 소프트웨어 공급망 거버넌스를 추적하고 자동화하는 snyk과 Dependabot 등의 도구가 등장했으며 깃허브는 이미 이들을 실제로 사용하고 있다.  

엔터프라이즈 아키텍트는 배포 파이프라인을 통해 전체 프로젝트에서 일관적인 테스트를 추진할 수 있다.  


### 9.3.2 기존 통합 아키텍처의 경계 콘텍스트

계층 아키텍처의 목표는 관심사를 분리하는 것이며, 이를 통해 재사용성을 높이는 것이다.  

DDD가 등장한 이후 아키텍트는 DDD에서 영감을 받은 아키텍처를 설계하기 시작했다.  
이러한 아키텍처는 경계 콘텍스트 개념을 중요하게 여긴다.  

이 두 패턴은 근본적으로 서로 호환되지 않는다.  

피트니스 함수로 아키텍처 구조를 보완해야 한다.  

각 분할 지점에 피트니스 함수를 구축하면 우발적인 커플링을 방지할 수 있다.  
피트니스 함수의 모습은 피트니스 함수가 보호하려는 자산에 따라 달라진다.  
동조성의 지역성 원칙을 고수하고 경계 콘텍스트의 원칙이 깨지지 않도록 보호하는 것이다.  

> ArchUnit


## 9.4 시작 지점

진화성 구축의 첫 단계는 일반적으로 적정 커플링과 모듈 사용성을 파악하는 것이지만, 가끔 다른 우선순위를 따라야 할 때가 있다.  


### 9.4.1 낮게 매달린 과일

아키텍트는 아키텍처에서 가장 다루기 쉬운 요소를 선택해야 한다.  

'가장 쉬운 것부터' 원칙은 가치를 비용을 대가로 리스크를 최소화한다.  


### 9.4.2 최대 가치 우선

시스템의 가장 중요한 부분을 확인하고 이를 중심으로 진화적 행동을 구축하는 방식이다.  

1. 아키텍트의 헌신을 강조하는 효과가 있다.  
2. 가장 가치가 높은 부분을 먼저 선택함으로써 진화적 아키텍처가 가져올 장기적인 가치를 가늠해볼 수 있다.  
3. 시스템의 가장 중요한 부분을 통해 개념을 증명함으로써 향후 진행 여부를 결정하는 데이터를 얻을 수 있다.  


### 9.4.3 테스트

코드를 재구성하기에 앞서 대략적인 기능 테스트를 추가하면 재구성 이후 시스템의 행동이 변경되지 않았는지 전반적으로 검증할 수 있다.  

테스트는 진화적 아키텍처의 증분 변경에 관련된 중요한 컴포넌트이며, 피트니스 함수는 테스트를 적극적으로 활용한다.  

> 최근에 단일모듈로된 프로젝트를 멀티모듈로 분리하는 중  
> 테스트 코드가 성공한다는 것 자체만으로 안심하고 넘어갈 수 있어서 분리작업을 빠르게 진행할 수 있었음  


### 9.4.4 인프라스트럭처

인프라에 결함이 있는 기업은 진화적 아키텍처를 구축하기에 앞서 이 문제를 먼저 바로잡는 것을 고려해야 한다.  

아키텍트와 개발자가 모범 사례를 등한시할 경우 결과적으로 엄청난 양의 기술 부채가 인프라 내부에 축적된다.  


### 9.4.5 사례 연구 PenultimateWidgets의 엔터프라이즈 아키텍처

아키텍트는 이 방식에 몇가지 문제가 있음을 깨달았다.  
1. 프로젝트에서 62개 속성을 일일이 검증할 수 있는가?
2. 시스템의 모든 부분에 엄격한 가용성 지침을 적용하는 것이 이치에 맞는가? 포괄적인 정책은 종종 지독한 오버엔지니어링을 낳는 원인이 되기도 한다.  

이러한 문제를 해결하기 위해 엔터프라이즈 아키텍트는 피트니스 함수로 기준을 정의하고 신규 프로젝트용 배포 파이프라인 템플릿을 만들었다.  


## 9.5 미래 전망

### 9.5.1 AI를 활용한 피트니스 함수

신용 카드 업체는 AI를 이용한 휴리스틱을 구현하고 세계 각지에서 발생하는 근 실시간 트랜잭션을 감지하는 용도로 활용하고 있다.  

### 9.5.2 생성 테스트

생성 테스트는 개발자가 대량의 테스트를 실행하고 결과를 수집한 다음 통계와 분석을 이용해 이상 행동을 발견한다.  
생성 테스트는 가능한 모든 값을 대입하고 문제가 발생한 경계 조건을 보고한다.  


## 9.6 되는 이유와 안 되는 이유

### 9.6.1 기업이 진화적 아키텍처를 구축하는 이유

#### 예측성 vs 진화성

소프트웨어 개발 생태계의 동적 균형으로 인해 예측성의 가치는 퇴색되었다.  

견고하고 안정적인 산업 분야도 진화가 멈춘 시스템의 위험성을 간과해서는 안 된다.  

진화적 아키텍처를 구축하려면 시간과 노력이 필요하다.  
그러나 이에 대한 보상은 대대적인 재작업 없이 시장의 실제 변화에 대응할 수 있을 때 주어진다.  
개발자가 몸담은 세계는 특유의 높은 변동성을 앞세워 모든 조직이 점진적인 변화를 향해 나아가도록 압력을 가하고 있다.  

#### 확장성

아마존은 모든 것이 연결된 단 하나의 지점(관계형 데이터베이스, 엔터프라이즈 서비스 버스 등)이 궁극적으로 확장성을 제한한다는 사실을 깨달았다.  

#### 고급 비즈니스 기능

진화적 아키텍처가 없다면 A/B 테스트조차 수행하기 어렵다.  
진화적 아키텍처는 불가피하고 불특정한 변화에 맞서 기업의 기술적인 대응력을 높이는 역할을 한다.  

#### 비즈니스 지표로서의 순환 주기

치열한 경쟁 시장에 놓인 수 많은 기업은 순환 주기를 최고의 비즈니스 지표로 격상시켰다.  

#### 퀀텀 수준의 아키텍처 특성 격리

서로 다른 특성의 투 서비스를 하나의 모놀리스에 담으로면 양쪽의 요구 사항을 모두 수용하기 위한 트레이드오프를 절충해야 한다.  
그러나 퀀텀 수준에서 기술 아키텍처를 고립시킬 수 있다면 아키텍트는 양측의 요구 사항을 저울질할 필요 없이 각 퀀텀에 필요한 주요 특성에 온전히 집중할 수 있다.  

#### 적응 vs 진화

많은 조직이 점진적으로 증가하는 기술 부채와 재구조화 지연이라는 함정에 빠진다.  
이에 따라 시스템과 통합 지점은 점점 취약해진다.  

진화적 아키텍처 구축은 아키텍처의 변화를 의미하며, 변화 과정에서 아키텍처가 중단되지 않도록 피트니스 함수를 이용해 보호해야 한다.  


### 9.6.2 기업이 진화적 아키텍처를 구축하지 않는 이유

#### 커다란 진흙 공

기존 아키텍처를 진화적 아키텍처로 변환하는 첫 단계는 모듈성 파악이다.  
현재 시스템에 존재하는ㄴ 모든 모듈성을 확인하고 이를 중심으로 아키텍처를 재구성하는 것이다.  

#### 지배적인 아키텍처 특성

서로 상충되는 핵심 목표를 동시에 완벽하게 지원할 수 있는 아키텍처는 없다.  

#### 희생적 아키텍처

희생적 아키텍처 유형으로 먼저 구축하고, 제품이 시장에서 검증된 이후 더욱 견고한 아키텍처를 구축할 것을 기약한다.  

#### 폐업 예정 비즈니스 

만일 1년 이내에 사업을 접을 계획이라면 아키텍처에 진화성을 구축할 이유가 없다.  


## 요약

진화적 아키텍처는 소프트웨어 엔지니어링 분야에 누적된 경험과 이를 기반으로 확립된 아키텍처 거버넌스를 다루는 전체론적 접근법이다.  

아키텍트가 모든 피트니스 함수를 공들여 구현할 필요는 없다.  
아키텍트는 고가치가 부여된 피트니스 함수에 주력하고 이들을 만들어 유지하는 노력을 정당화할 수 있어야 한다.  
아키텍처의 진화에 절대적인 최종 상태란 없다.  


