# 2장 자바 메모리 영역과 메모리 오버플로

## 2.1 들어가며

하지만 통제권을 위임했기 때문에 문제가 한번 터지면 가상 머신의 메모리 관리 방식을 이해하지 못하는 한 해결하기가 상당히 어렵다.  

## 2.2 런타임 데이터 영역

### 2.2.1 프로그램 카운터

프로그램 카운터 레지스터는 작은 메모리 영역으로, 현재 실행 중인 스레드의 '바이트코드 줄 번호 표시기'라고 생각하면 쉽다.  

스레드 전환 후 이전에 실행하다 멈춘 지점을 정확하게 복원하려면 스레드 각각에는 고유한 프로그램 카운터가 필요하다.  
따라서 각 스레드의 카운터는 서로 영향을 주지 않는 독립적인 영역에 저장된다.  
이 메모리 영역을 스레드 프라이빗 메모리라고 한다.  


### 2.2.2 자바 가상 머신 스택

자바 가상 머신 스택도 '스레드 프라이빗'하며, 연결된 스레드와 운명을 같이 한다.  
그런 다음 스택 프레임을 가상 머신 스택에 푸시하고 메서드가 끝나면 팝하는 일을 반복한다.  

'스택'이라고 하면 보통 자바 가상 머신 스택을 가리키는데, 특히 지역 변수 테이블을 가리킬 때가 많다.  

지역 변수 테이블에서 이 데이터 타입들을 저장하는 공간을 지역 변수 슬롯이라 한다.  
일반적으로 슬록의 크기는 32비트이다.  
지역 변수 테이블을 구성하는 데 필요한 데이터 공간은 컴파일 과정에서 할당된다.  

스레드가 요청한 스택 깊이가 가상 머신이 허용하는 깊이보다 크다면 `StackOverflowError`를 던진다.
여유 메모리가 충분하지 않다면 `OutOfMemoryError`를 던진다.


### 2.2.3 네이티브 메서드 스택

가상 머신 스택은 자바 메서드(바이트코드)를 실행할 때 사용하고, 네이티브 메서드 스택은 네이티브 메서드를 실행할 때 사용한다.  

```
네이티브 메서드  
JNI는 Java 프로그램이 다른 언어로 작성된 프로그램과 상호 작용할 수 있게 해주는 인터페이스로 C 와 C++ 로 작성된 프로그램과의 상호작용을 위해 사용됩니다.  
native 키워드를 사용하여 선언되며 실제 구현은 Java가 아닌 C/C++ 로 작성됩니다.  
start0() 메소드는 OS 가 바로 읽을 수 있는 형태의 native code 를 호출하기 위해 native 메소드를 사용하고 있는 예가 됩니다.  

https://ones1kk.tistory.com/entry/Java-Native-Method
```


### 2.2.4 자바 힙

자바 힙은 모든 스레드가 공유하며 가상 머신이 구동될 때 만들어진다.  
힙 메모리 영역의 유일한 목적은 객체 인스턴스를 저장하는 것이고, 자바 세계의 '거의'모든 객체 인스턴스가 이 영역에 할당된다.  

자바 힙은 가비지 컬렉터가 관리하는 메모리 영역이기 때문에 GC 힙이라고도 한다.  

자바 힙을 다시 작게 구분하는 목적은 오직 메모리 회수와 할당을 더 빠르게 하기 위함이다.  

자바 힙은 물리적으로 떨어진 메모리에 위치해도 상관없으나 논리적으로는 연속되어야 한다.  


### 2.2.5 메서드 영역

메서드 영역도 모든 스레드가 공유한다.  
메서드 영역은 가상 머신이 읽어 들인 타입 정보, 상수, 정적 변수 그리고 JIT 컴파일러가 컴파일한 코드 캐시 등을 저장하는 데 이용된다.  


### 2.2.6 런타임 상수 풀

런타임 상수 풀은 메서드 영역의 일부다.  
상수 풀 테이블에는 클래스 버전, 필드, 메서드, 인터페이스 등 클래스 파일에 포함된 설명 정보에 더해 컴파일타임에 생성된 다양한 리터럴과 심벌 참조가 저장된다.  


### 2.2.7 다이렉트 메모리

다이렉트 메모리는 가상 머신 런타임에 속하지 않으며 자바 가상 머신 명세에 정의된 영역도 아니다.  

> OS에서 관리하는 메모리 영역으로 이해 함  
> Network I/O 과정에서 힙 메모리로 변환하면 느리기 때문에 물리적인 메모리를 직접 사용하여 속도를 향상시킴  
> 
> [NIO] JAVA NIO의 ByteBuffer와 Channel로 File Handling에서 더 좋은 Perfermance 내기!  
> http://eincs.com/2009/08/java-nio-bytebuffer-channel-file/  




