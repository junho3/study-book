# 6장 서버 메트릭

MySQL 메트릭은 성능과 밀접한 관련이 있습니다.  
다만, 이것들이 어떻게 관련되는지는 분명하지 않습니다.  

MySQL 메트릭을 자주 다루기는 하지만 제대로 배운 적은 없으므로 블랙박스로 간주하더라도 그리 틀리지는 않을 겁니다.  
MySQL 메트릭 참고 자료나 문서가 부족한 이유는 메트릭이 나타내는 바가 자명해서 이해하거나 해석할 필요가 없다는 잘못된 가정 때문입니다.  

메트릭은 워크로드가 MySQL이라는 프리즘을 통과하면서 굴절되어 드러나는 스펙트럼입니다.  

- MySQL에서 워크로드를 실행하면 메트릭 결과는 MySQL이 아닌 워크로드의 속성을 나타냅니다.
- 성능은 쿼리, 데이터, 접근 패턴과 같이 워크로드에 직접적인 영향을 받습니다.

MySQL 서버 성능을 이해하고 분석하는 데 필요한 메트릭은 극히 일부에 불과합니다.  
나머지 메트릭의 관련성과 중요성은 다양합니다.  

- 일부는 잡음입니다.
- 일부는 더는 사용하지 않습니다.
- 일부는 기본적으로 비활성화되어 있습니다.
- 일부는 기술적으로 매우 구체적입니다.
- 일부는 특정한 경우에만 유용합니다.
- 일부는 정보 제공용이며 적절한 메트릭이 아닙니다.
- 일부는 사람이 이해하기 어렵습니다.


## 6-1 쿼리 성능 대 서버 성능

MySQL 성능에는 쿼리 성능과 서버 성능이라는 2가지 측면이 있습니다.

- 쿼리 성능: 워크로드 최적화
- 서버 성능: 워크로드를 처리하는 MySQL 성능

입력은 워크로드이고 출력은 서버 성능입니다.  
최적화된 워크로드를 MySQL에 넣으면 성능이 향상됩니다.  

### 동시성과 경합

동시성은 쿼리 성능을 떨어뜨리는 경합으로 이어집니다.  
단독으로 실행되는 쿼리는 다른 쿼리와 함께 실행될 때 다른 성능을 냅니다.  

서버 성능 분석은 모든 쿼리가(동시성) 공유되고 제한된 시스템 리소스를 놓고 경쟁할 때 MySQL이 워크로드를 처리하는 방식을 확인하는 데 가장 유용하고 일반적으로 수행됩니다.  

### 튜닝

서버 성능에는 MySQL, 운영체제, 하드웨어 등 3가지 추가 요소가 있습니다.  

튜닝을 해야 한다면 알려진 안정적인 워크로드로 서버 성능을 분석해야 합니다.  
그렇지 않으면 성능 향상이 튜닝의 결과라고 확신할 수 없습니다.  
튜닝 결과는 제어, 변수, 재현성, 반증 가능성과 같은 기초 지표를 이용하여 과학적으로 측정할 수 있습니다.  

### 성능 회귀

일반적으로 쿼리 성능, MySQL 튜닝, 하드웨어 결함이 문제가 아님을 확인한 전문가는 최후 수단으로 성능 회귀(또는 버그)를 의심합니다.  

튜닝과 성능 회귀는 MySQL DBA와 전문가의 책임입니다.  


## 6-2 정상과 안정

인간은 패턴 인식에 능숙해서 어떤 메트릭을 보여주는 차트가 비정상인지 쉽게 알 수 있습니다.  

### 정상

정상은 성능의 일부 측면이 평소보다 더 높거나 낮은지, 더 빠르거나 느린지, 더 좋거나 나쁜지를 결정하는 기준선입니다.  

### 안정

더 나은 성능을 추구하는 과정에서 안정적인 성능을 놓쳐서는 안 됩니다.  
한계에서 성능이 불안정해지면 성능보다 더 큰 문제가 발생합니다.  


## 6-3 핵심 성능 지표

### 응답 시간

쿼리 응답 시간이 MySQL 성능의 핵심이라 설명했듯이 응답 시간은 모두가 관심을 두는 유일한 지표입니다.  
그러나 응답 시간이 빠르더라도 다른 핵심 성능 지표도 함께 고려해야 합니다.  

### 오류

기본적은 쿼리 오류뿐만 아니라 쿼리, 연결, 클라이언트, 서버와 같은 모든 오류를 포함합니다.  

### QPS

QPS는 성능을 나타내지만 그 자체가 성능은 아닙니다.  

### 실행 중인 스레드

실행 중인 스레드는 MySQL이 QPS를 달성하기 위해 얼마나 노력하는지를 측정합니다.  
목표는 정상이고 안정적인 스레드 실행, 즉 낮을수록 좋습니다.  

응답 시간, 오류율, QPS, 실행 중인 스레드는 항상 모니터링하세요.  


## 6-4 메트릭 필드

메트릭 필드는 메트릭이 어떻게 관련되어 있는지 이해하기 위한 모델입니다.  

### 응답 시간 메트릭

응답 시간 메트릭은 MySQL이 응답하는 데 걸리는 시간을 나타냅니다.  
하위 수준의 세부 사항을 포함하므로 메트릭 필드에서 최상위 수준입니다.  

### 속도 메트릭

속도 메트릭은 MySQL이 개별 작업을 얼마나 빨리 완료하는지를 나타냅니다.  
초당 쿼리 수(QPS)는 어디에나 있으며 보편적으로 알려진 데이터베이스의 속도 메트릭입니다.  

전반적으로 QPS가 증가하면 쿼리가 많을수록 CPU 시간이 더 많이 필요하므로 CPU 사용률이 증가할 수 있습니다.  
CPU 사용률이 증가하는 것을 방지하거나 줄이려면 쿼리를 최적화하여 실행하는 데 필요한 CPU 시간을 줄여야 합니다.  

### 사용률 메트릭

사용률 메트릭은 MySQL이 유한한 리소스를 얼마나 많이 사용하는지를 나타냅니다.  
- CPU 사용량
- 메모리 사용량
- 디스크 사용량

**제한 속도**는 사용률로 표현할 수 있습니다.  
디스크 I/O 사용률은 최대 속도 대비 현재 속도입니다.  
**무한 속도**는 최대 속도가 없기 때문에 사용률로 표현할 수 없습니다.  

사용률이 높아지면 관련 속도가 낮아질 수 있습니다.  

사용률이 100%에 가까워지면 MySQL은 대기합니다.  

부하를 줄이거나(워크로드 최적화) 하드웨어 용량을 늘려 개선할 수 있습니다.  
회전 디스크를 NVMe로 업그레이드하면 스토리지 대기 시간이 크게 줄어듭니다.  

### 대기 메트릭

대기 메트릭은 쿼리 실행 중 유휴 시간을 나타냅니다.  
경합과 일관성으로 인해 쿼리 실행이 지연되면 대기가 발생합니다.  
대기 메트릭은 속도나 응답 시간으로 계산하지만, MySQL이 작동하지 않을 때를 나타내므로 별도로 분류할 가치가 있습니다.  

대기는 피할 수 없습니다.  
목표는 대기를 없애는 것이 아니라 줄이고 안정시키는 것입니다.  

대기 이벤트: transactions - statements - stages - waits  

MySQL이 너무 오래 기다리면 대기-오류 관계인 시간 초과(timeout)가 발생합니다.  
- max_execution_time
- lock_wait_timeout
- innodb_lock_wait_timeout
- connect_timeout
- wait_timeout

이 설정을 사용하되 의존해서는 안 됩니다.  

### 오류 메트릭

오류 메트릭은 오류를 나타냅니다.  
대기와 마찬가지로 오류도 비율로 계산되지만, MySQL이나 클라이언트가 실패한 시기를 나타내므로 별도로 분류할 가치가 있습니다.  

### 접근 패턴 메트릭

접근 패턴 메트릭은 애플리케이션이 어떻게 MySQL을 사용하는지를 나타냅니다.  
Com_select 접근 패턴 메트릭은 실행된 SELECT 문의 수를 계산합니다.  
응답 시간이 형편없고 Select_full_join 접근 패턴 메트릭이 높다면 이는 결정적인 증거입니다.  

### 내부 메트릭

MySQL 엔지니어나 사용자는 알 필요도 없고 관심을 둘 필요도 없기 때문입니다.  
그러나 이것은 이 분야에서 가장 흥미로운 부분이며, MySQL을 더 자세히 이해하고 싶을 때를 대비하여 충분히 알았으면 합니다.  


## 6-5 스펙트라

각 스펙트럼을 구성하는 MySQL 메트릭과 시스템 변수에 관해 정확하게 이야하기려면 **메트릭 명명 규칙**이 필요합니다.  
MySQL에는 메트릭 명명 규칙이 없으며 업계 표준도 없기 때문입니다.  

- 전역: MySQL 서버 전체(모든 클라이언트, 모든 사용자, 모든 쿼리 등)
- 세션 메트릭: 단일 클라이언트 연결로 범위가 지정된 전역 메트릭
- 요약 메트릭: 계정, 호스트, 스레드 트랜잭션 등 다양한 측면으로 범위가 지정된 전역 메트릭의 하위 세트

