# 10장 실시간 게임 순위표

## 1단계: 문제 이해 및 설계 범위 확정

- 경기에서 승리하면 포인트 획득
- 모든 플레이어가 순위표에 포함
- 매달 새로운 토너먼트를 시작할 때마다 새로운 순위표 생성
- 상위 10명과 특정 사용자의 순위 표시
- DAU 500만명, MAU 2,500만명
- 각 선수는 하루 평균 10경기
- 점수가 같을 경우 순위는 동일
- 순위표는 실시간 또는 준실시간

### 기능 요구사항

### 비기능 요구사항

- 일반적인 확장성, 가용성 및 안정성 요구사항

### 개략적 규모 추정

게임 사용량이 균등한 경우는 별로 없으며, 북미 지역 기준 저녁 시간이 피크 시간대일 가능성이 높다.  
이를 고려하기 위해 최대 부하는 평균 5배라고 가정, 초당 최대 250명의 사용자를 감당할 수 있어야 한다.

- 사용자 점수 획득 QPS: 최대 2,500 QPS  
- 상위 10명 순위표 가져오기 QPS: 평균 50 QPS


## 2단계: 개략적 설계안 제시 및 동의 구하기

### API 설계

#### POST /v1/scores

#### GET /v1/scores

#### GET /v1/scores{:user_id}


### 개략적 설계안

클라이언트 > 게임 서비스 > 순위표 서비스 > 순위표 저장소

#### 클라이언트가 순위표 서비스와 직접 통신해야 하나?

클라이언트가 점수를 계산하면 중간자 공격을 할 수 있기 때문에 보안상 안전하지 않다.  
따라서 점수는 서버가 설정해야 한다.  

온라인 포커처럼 서버가 게임 전반을 통솔하는 경우에는 게임 서버가 모든 게임 로직을 처리하고, 클라이언트의 개입 없이도 점수를 정할 수 있다.  

#### 게임 서비스와 순위표 서버 사이에 메시지 큐가 필요한가?

데이터를 다른 곳에서도 사용하거나 여러 기능을 지원해야 한다면 카프카에 데이터를 넣는 것이 합리적일 수 있다.  

> 게임은 실시간 결과가 중요한데, 큐가 적합한건지?

### 데이터 모델

#### 관계형 데이터베이스

점수 갱신 쿼리  
`UPDATE leaderboard set score = score + 1 where user_id = 'xxxx';`
> Lock 필요

사용자 순위표 쿼리  
`SELECT (@rownum := @rownum + 1) AS rank, user_id, score FROM leaderboard ORDER BY score DESC;`

- 레코드가 많아질 수록 성능이 너무 나빠지는 문제가 있다.  
  - 사용자 순위를 포악하려면 모든 사용자를 순위표의 정확한 위치에 정렬해야 한다.  
- 데이터가 지속적으로 변경되기 때문에 캐시 도입도 불가능하다.  
- 일괄 작업으로 수행하면 RDS를 사용하는 것도 가능하겠지만, 실시간 순위를 보여주어야 한다는 요구사항에 부적합하다.  
- INDEX를 추가하고 LIMIT 절을 사용할 수 있지만, 규모 확장성이 좋지 않다.  

#### 레디스




