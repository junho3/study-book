# CHAPTER 2 피트니스 함수

피트니스 함수는 그중에서도 특히 중요한 보호 메커니즘이다.  
아키텍처에서 피트니스 함수의 역할은 애플리케이션 도메인에서 단위 테스트가 담당하는 역할과 동등하다.  

진화적 아키텍처는 여러 차원에 걸쳐 유도된 변화와 점진적 변화를 지원한다.  

## 2.1 정의

솔루션의 도메인 특성이 진화함에 따라 팀은 기존 기능을 해치지 않으면서 신기능을 통합하는 다양한 도구와 기법을 개발해왔다.  
실제로 일정 규모 이상의 기업들은 대부분 품질 보증 전담 조직을 두어 도메인 진화 관리를 일임한다.  

> 첫 회사는 작은 스타트업이라 전문 QA가 존재하지 않았음  
> 기획자와 개발자가 진행하는 제한된 테스트로 운영배포 후 종종 문제 발생  

단위 테스트의 대상이 도메인이라면 피트니스 함수의 대상은 아키텍처 특성이다.  
아키텍트는 다양한 도구를 사용해 피트니스 함수를 정의할 수 있다.  

### 모니터

> Grafana, Zipkin, Datadog

### 코드 메트릭

> JUnit, Kotest, 소나큐브, Ktlint와 같은 테스트 툴과 정적분석을 의미하는건지?

### 카오스 엔지니어링

> 경험해본적 없음

### 아키텍처 테스트 프레임워크

### 보안 스캐닝

관할 부서가 따로 있다 해도 보안은 아키텍트의 설계와 선택에 영향을 미친다.  

> 2023.10.11 AWS 행사 Fintech 섹션 발표에서 보안에 관한 얘기는 종종 나옴  
> 트레블월렛은 VISA와 통신을 해야하고, 기존 온프레미스 환경에서 네트워크장비를 통해 VISA와 통신을 했었음  
> 최근에 VISA가 AWS 내에 서비스를 구축 하였고, 파트너사는 AWS Direct Connect 활용하여 AWS 인프라에 있는 VISA와 통신  
> 
> 온프레미스 서비스를 클라우드로 전환하면서 VPC 설계, 데이터 관리 등을 어떻게 할 것인지?  

아키텍트는 컴포넌트 순환 순환 의존성을 안티패턴으로 간주한다.  
이러한 컴포넌트 중 하나를 개발자가 재사용하면 나머지 컴포넌트까지 얽혀서 난감한 상황이 발생하기 때문이다.  

> 레거시 코드의 대표적인 문제점  
> 코드 재활용 관점에서는 합리적이나 무분별한 재활용으로 참조하는 곳이 많을 경우, 사이드 이팩트 발생  
> 컬리에서 배송비 적립금을 계산하는 작은 함수를 수정했더니, 과세금액, 비과세금액 계산 등 전체적인 계산식에서 문제가 발생  

개발자는 이러한 어포던스에 너무나 익숙해진 나머지 아무런 주의를 기울이지 않고 반사적으로 응해버린다.  

> DTO Prefix

ArchUnit은 일점 범위 안의 순환 의존성을 비롯해 다양한 아키텍처 기능을 테스트할 수 있다.  
지속적 빌드 프로세스에서 이 테스트를 추가한다면 아키텍트가 순환 의존성을 걱정할 일은 더 이상 없을 것이다.  

진화적 아키텍처의 피트니스 함수 역시 소프트웨어로 구현할 수 없는 경우가 있다. (예: 규제로 인한 불가피한 수작업)  
아키텍처 피트니스 함수는 객관적인 척도지만 아키텍트는 다양한 방식으로 이 척도를 구현할 수 있다.  

성능 요구 사항은 피트니스 함수를 적용하기 좋은 영역이다.  
모든 서비스 호출에 100ms 이내로 응답해야 하다는 요구 사항이 있다고 하자.  
서비스 요청과 응답을 측정한 다음 결과가 100ms를 초과하면 실패하는 테스트(피트니스 함수)를 구현할 수 있다.  

성능 피트니스 함수의 목표는 모든 유형의 성능을 측정하는 것이 아니라 아키텍트가 중요하다고 판단한 거버넌스 요소의 성능을 측정하는 것이다.  

**아키텍처의 선택 사항 각각을 단일 또는 시스템 전체의 피트니스 함수를 통해 평가한다는 뜻이다.**  
**피트니스 함수는 해당 아키텍처에서 중요한 것이 무엇인가에 대한 총체적 정의이며, 소프트웨어 시스템 개발 과정에서 발생하는 중대하면서도 까다로운 트레이드오프를 판가름하는 기준이다.**  

> 어플리케이션과 연관된 모든 요소 (코드품질, 모듈간 의존성, 대외 API 연동, 보안 등)를 테스트(평가)해야 한다는 의미로 이해함  
> 통합 테스트의 상위 버전  
> 지금할 수 있는 것은 테스트 코드 커버리지 측정정도  


## 2.2 범주

### 2.2.1 스코프: 원자 vs 전체

원자 피트니스 함수는 단일 콘텍스트로 실행되며 아키텍처의 특정 측면을 검사한다.  
모듈러 커플링처럼 하나의 아키텍처 특성을 검증하는 단위 테스트는 원자 피트니스 함수의 좋은 예다.  

전체 피트니스 함수는 공유 콘텍스트에서 실행되며 여러 아키텍처 측면을 조합해 검사하도록 설계된다.  
데이터의 부패도는 보안 피트니스 함수의 주요 검사항목이다.  
확장성을 검사할 때는 특정 레이턴시 범위의 동시 사용자 수를 중요하게 본다.  


### 2.2.2 케이던스: 트리거 vs 지속 vs 시간

트리거 피트니스 함수는 개발자나 배포 파이프라인이 실행한 단위 테스트, QA 담당자가 수행하는 탐색 테스트 등의 특정 이벤트를 기반으로 실행된다.  
개발자에게 익숙한 단위 테스트, 기능 테스트, 행동 주도 개발 (BDD) 테스트 등이 모두 여기에 포함된다.  

아키텍트는 실제 트랜잭션이 실행되는 동안 프로덕션 환경에서 또 다른 트랜잭션을 시뮬레이션하는 지속 피트니스 함수를 구축해야 한다.  
이러한 기법을 흔히 합성 트랜잭션이라 부른다.  

모니터링 주도 개발 (MDD)은 최근 많은 관심을 받는 테스트 기법이다.  

업그레이드 중단 테스트도 시간 피트니스 함수의 용도에 알맞다.  

더욱이 핵심 프레임워크 업그레이드는 시간이 많이 소요되는 작업이지만 긴급성이 낮다고 간주되어 우선순위에서 밀리곤 한다.  
이런 상황을 방지하기 위해 아키텍트는 시간 피트니스 함수를 사용할 수 있다.  
Dpendabot 또는 snyk처럼 소프트웨어의 릴리즈, 버전, 보안 패치를 추적하는 도구를 함께 활용한다.  

> 컬리에서 PHP 버전을 크게 올려야할 때 자동화 테스트가 존재하지 않아 스테이징에 한 달 이상 올려놓고, 모니터링 후 운영에 배포했음  
> PHP Laravel은 Composer라는 의존성 관리 툴로 라이브러리의 버저닝 관리를 하였고, 자주 버전 업을 했었음  
> 
> 개인적으로는 어플리케이션에서 사용하는 라이브러리(Ktlint, Kotest 등) 버전업을 꾸준히 하려고 함  
> Spring boot 프로젝트들은 혹은 개발자들은 버전 업을 잘 안하는 것 같은 느낌  


### 2.2.3 트리거 vs 지속

지속 피트니스 함수 또는 트리거 피트니스 함수를 선택하는 기준을 퀀텀의 적용 결과에 따른 트레이드오프로 결정되곤 한다.  

> Zipkin으로 서비스간 호출은 확인할 수 있지만, 규정을 위반한 통신을 어떻게 관리할 수 있을까?  

배포 파이프라인은 정규 케이던스에 맞추어 피트니스 함수를 호출하며 로그 파일을 수집하고 모든 통신이 이상 없는지 확인한다.  


### 2.2.4 정적 vs 동적

정적 피트니스 함수는 단위 테스트의 통과/실패처럼 고정적인 결과를 낸다.  
동적 피트니스 함수는 외부 콘텍스트, 실시간 콘텐츠처럼 변화하는 대상을 근거로 정의된다.  

역동성과 객관성은 상충하는 특성이 아니다.  
피트니스 함수는 객관적인 결과로 평가되어야 하지만 평가의 근거는 동적 정보를 바탕으로 세워질 수 있다.  


### 2.2.5 자동 vs 수동

아키텍트는 자동화를 좋아하며, 자동화는 점진적 변화의 일부다.  
일부 특수한 프로젝트는 여전히 QA를 수동으로 진행해야 하며 근시일 내에 자동화되지 못할 가능성이 크다.  

> 셀레니움 등으로 자동화할 수 있을 것 같긴한데


### 2.2.6 의도 vs 긴급

피트니스 함수는 아키텍트가 프로젝트를 분석하며 세웠던 최초의 가정을 검증하는 동시에, 실 시간 거버넌스 역할까지 수행한다.  
단위 테스트와 마찬가지로 피트니스 함수는 팀 코드베이스의 일부가 된다.  
아키텍처 요구 사항이 변경되고 발전함에 따라 피트니스 함수도 적절히 변경 되어야 한다.  


### 2.2.7 도메인별 피트니스 함수

피트니스 함수는 순수한 아키텍처 문제로 한정하고 도메인의 문제는 다른 검증 절차에서 처리하도록 하는 것이 현명한 조치다.  


## 2.3 피트니스 함수는 누가 작성하는가

피트니스 함수는 단위 테스트에 대한 아키텍처의 아날로그적 해석이다.  
개발 및 엔지니어링 관행에서도 둘은 유사하게 취급되어야 한다.  


## 2.4 피트니스 함수 테스트 프레임워크 선택

아키텍트 또한 플랫폼과 비슷한 수준에서 아키텍처 피트니스 함수를 지원하는 턴키 도구를 찾고자 하지만, 일반적으로 이러한 도구는 존재하지 않는다.  
피트니스 함수의 특성이 매우 다양하기 때문이다.  


## 2.5 결과 vs 구현

피트니스 함수는 아키텍처 특성에 대한 객관적인 평가를 도출한다.  
독자들은 아키텍트의 측정 기법 자체보다 측정의 이유와 결과에 더 집중하는 것이 좋다.  

피트니스 함수들을 한데 모아 시스템 피트니스 함수라는 개념을 부여할 수 있다.  
이들이 서로 충돌하는 상황이 발생하면 시스템 피트니스 함수를 통해 문제 해결에 필요한 트레이드오프를 파악할 수 있다.  

시스템 피트니스 함수는 아키텍처의 진화에서 결정적인 역할을 한다.  
아키텍처의 특성을 서로 비교하고 평가하려면 적합한 근거가 필요하기 때문이다.  

아키텍트에게 있어 가장 중요한 것은 확장성, 성능, 보안, 데이터 스키마 등의 핵심 차원을 아키텍처 설계 초기에 정의하는 것이다.  
이를 통해 아키텍트는 시스템 전반의 주요 행동을 파악하고 그 결과를 바탕으로 피트니스 함수의 중요도를 가늠할 수 있다.  

각종 거버넌스 도구와 기법을 모두 피트니스 함수로 다루기 시작하면, 팀은 실행 중심 조직으로 통합을 이룰 수 있다.

