# 5장 지표 모니터링 및 경보 시스템

## 1단계: 문제 이해 및 설계 범위 확정

지표 모니터링 및 경보 시스템의 의미는 회사마다 다를 수 있으므로, 면접관과 상의하여 정확한 요구사항을 알아내는 것이 중요하다.  

### 개략적 요구사항 및 가정

- 회사 내부 시스템 (Sass 아님)
- CPU 부하, 메모리 사용률, 디스크 사용량, TPS, 메시지 큐의 메시지 수 ...
- DAU 1억 명, 1000개의 서버 풀, 풀마다 100개의 서버 하드웨어
- 데이터는 1년간 보관
- 신규 데이터는 7일동안 보관 > 1분 단위 데이터로 만들어 30일동안 보관 > 1시간 단위 데이터로 만들어서 1년동안 보관
- 이메일, 전화, 페이저듀티, 웹훅 등을 채널로 지원해야 함
- 에러 로그나 액세스 로그는 수집하지 않아도 됨
- 분산 시스템 추적을 지원하지 않아도 됨

> 페이저 듀티  
> PagerDuty는 모든 소프트웨어에 실시간 서비스를 제공하여 시스템 오류 신호를 인지하고 해석하여 이를 적절한 팀원들에게 실시간 조치를 취하도록 알려주며 소프트웨어와 인간의 반응 정보를 머신러닝을 통해 자동화 프로세스를 지속적으로 플랫폼 내에 저장하여 향후 일어날 사고에 대해 사전 대처를 할 수 있도록 도와주는 서비스를 제공하고 있습니다.  
> https://overseasmarket.tistory.com/211  

### 비기능 요구사항

- 규모 확장성
- 낮은 응답 지연
- 안정성: 중요 경보를 놓치지 않아야 함
- 유연성: 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 이용해 구축해야 함


## 2단계: 개략적 설계안 제시 및 동의 구하기

### 기본적 사항

- 데이터 수집
- 데이터 전송
- 데이터 저장소
- 경보
- 시각화

### 데이터 모델

지표 데이터는 통상 시계열 데이터 형태로 기록한다.  

CPU.load host=webserver01,region=us-west 1613707265 50

- CPU.load: 지표 이름  
- host=webserver01,region=us-west: 태그/레이블 집합  
- 1613707265 50: 지표 값 및 그 타임스탬프의 배열

시스템에 대한 쓰기 부하는 막대하다.  
읽기 부하는 일시적으로 치솟았다 사라지는 편이다.  

> SRE팀으로부터 읽기 부하 때문에 브라우저에서 grafana를 계속 켜두지 말아달라는 요청이 있었음  

### 데이터 저장소 시스템

지표 모니터링 및 경보시스템을 위한 저장소 시스템을 직접 설계하거나, MySQL 같은 범용 저장소 시스템을 사용하는 선택지를 추천하지 않는다.  
범용 데이터베이스는 이 설계안이 감당하려는 부하 규모에 맞추려면 전문가 수준의 튜닝이 필요하다.  

관계형 데이터베이스는 시계열 데이터를 대상으로 수행하는 연산에 최적화되어 있지 않다.  
태그/레이블 질의를 지원하려면 태그마다 인덱스를 지정해야 하는 문제가 있다.  
많은 양의 쓰기 연산이 지속적으로 발생하는 환경에서 성능이 좋지 않다.  

NoSQL로 시계열 데이터를 효과적으로 저장하고 질의하기 위해서는 확장이 용이한 스키마를 설계해야 하는데, NoSQL에 대한 이해도가 높아야 한다.  

- OpenTSDB: Hadoop과 HBase 기반
- MetrixcsDB: 트위터
- Timestream: AWS
- InfluxDB
- Prometheus

> Promethus 사용 중  

좋은 시계열 데이터베이스는 막대한 양의 시계열 데이터를 레이블 기준으로 집계하고 분석하는 기능을 제공한다.  
레이블 기반의 신속한 데이터 질의를 지원하기 위해 레이블별로 인덱스를 구축한다.  
레이블을 이용할 때 데이터베이스 과부하를 피하는 지침도 제공한다.  

### 개략적 설계안

- 지표 출처: 지표 데이터가 만들어지는 애플리케이션, DB, 메시지 큐 등..
- 지표 수집기: Prometheus
- 시계열 데이터베이스
- 질의 서비스: Grafana
- 경보 시스템: Slack, Opsgenie
- 시각화 시스템: Grafana


## 3단계: 상세 설계

### 지표 수집

지표 수집은 때로 데이터가 소실되어도 심각한 문제는 아니다.  
클라이언트는 성공적으로 데이터가 전송되었는지 신경 쓰지 않아도 된다.  

#### 풀 모델

지표 수집기 서버가 모든 서비스 앤드포인트를 관리하고, 주기적으로 지표 데이터를 가져온다.  
서버가 수시로 추가/삭제되는 대규모 운영 환경에는 적용하기 어렵다.  
etcd, 아파치 주키퍼 같은 서비스 탐색 기술을 활용하면 이 문제를 해결할 수 있다.  

지표 수집기 서버가 여러 대일 때 같은 출처에서 데이터를 중복해서 가져올 가능성이 있다.  
안정 해시 링을 사용해서 해당 구간에 속한 서버로부터 생산되는 지표 수집을 담당하는 수집기 서버를 지정하는 것이다.  

#### 푸시 모델

웹 서버나 데이터베이스가 직접 지표를 수집기에 전송하는 모델이다.  
모니터링 대상 서버에 통상 수집 에이전트 소프트웨어를 설치한다.  

데이터 집계는 수집기에 보내는 데이터의 양을 줄이는 효과적인 방법이다.  
만일 에이전트가 위치한 서버가 오토 스케일링으로 동적으로 추가되거나 삭제될 때 데이터가 소실될 수도 있다.  
지표 수집기 클러스터도 오트 스케일링 설정을 추가하고 로드벨렌서를 두는 것이 좋다.  

#### 풀모델 vs 푸시 모델 장단점 비교

- 풀 모델: Prometheus
- 푸시 모델: AWS CloudWatch, Graphite



