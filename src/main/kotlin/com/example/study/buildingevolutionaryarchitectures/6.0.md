# CHAPTER 6 진화적 데이터

데이터는 아키텍처 커플링보다 더 골치 아픈 결합 구조를 형성하곤 한다.  

> 위와 같은 이유로 서비스 로직에서 Jpa 엔티티를 직접 사용하는건 싫어함  

데이터는 진화적 아키텍처 설계에서 매우 중요하게 다루는 차원이다.  
특히 마이크로서비스 아키텍처는 데이터 파티셔닝, 의존성, 트랜잭션 등을 더욱 심도 깊게 고려해야 한다.  


## 6.1 진화적 데이터베이스 설계

진화적 데이터베이스 설계란 요구 사항의 변화에 따라 발전하는 데이터베이스를 구축하는 것이다.  


### 6.1.1 진화적 스키마

진화적 데이터베이스 설계의 핵심은 진화하는 스키마이며, 이는 코드를 통해 실현할 수 있다.  
개발자는 데이터베이스 변경 사항을 마치 소스 코드처럼 테스트하고, 버전을 매기고, 증분 형태로 관리 해야 한다.  

> 토스ㅣSLASH 22 - 토스뱅크의 완전히 새로운 대출 시스템  
> https://youtu.be/SLamxuykpnw?feature=shared  
> DB 버전 관리 Flyway 소개  


#### 테스트

ORM 등의 데이터 매핑 도구를 사용하는 경우, 피트니스 함수를 통해 매핑 코드와 스키마를 항상 동기화시키는 것이 좋다.  

> qa, prod 환경은 validate를 설정해놓는 편  
> jpa.hibernate.ddl-auto: validate  
> 
> JPA, Exposed 엔티티 검증 (동현님 아이디어)  
> https://github.com/junho3/practice-kotlin-spring-boot/commit/4a9ab2e7babbea45c32f347b2cfb0d086d99df0d


#### 버전 관리

#### 증분 변경

> 테이블 변경은 DA#이라는 솔루션으로 관리하고, 테이블 변경 작업은 DBA가 진행하고 있어서 개발자가 관여하진 않음  


### 6.1.2 공유 데이터베이스 통합

공유 데이터베이스 통합 패턴은 데이터베이스를 공유 메커니즘으로 사용하는 통합 패턴이다.  

데이터베이스를 통합 지점으로 활용하면 이를 공유하는 모든 프로젝트에서 스키마가 고착화될 우려가 있다.  
애플리케이션 A가 스키마를 변경하면 다른 애플리케이션은 잠재적 장애 위험에 처한다.  

> MSA에서는 DB를 분리하는 것에 동의 (단일 퀀텀)  
> 그러나 비용적인 측면도 있기 때문에 단일 인스턴스에 스키마만 분리하는 것도 좋은 선택이라고 생각 함  

문제의 소지가 있는 커플링을 해소하는 일반적인 리팩터링 패턴이 바로 확장/수축 패턴이다.  

> 확장/수축 패턴  
> 1. 기존 컬럼은 유지하고, 새로운 컬럼을 추가  
> 2. 기존 컬럼과 새로운 컬럼 모두 데이터를 저장  
> 3. 기존 컬럼 삭제  
>
> 기존 컬럼을 참조하지 않는지 어떻게 알 수 있을까?  
> git repo에서 컬럼명 검색? name이라는 컬럼명은 검색 결과가 많을탠데?  

#### 조건 1: 통합 지점 없음, 레거시 데이터 없음

#### 조건 2: 레거시 데이터 존재, 통합 지점 없음

#### 조건 3: 기존 데이터 존재, 통합 지점 존재

> SQL TRIGGEER 명령어로 해결하는 방법을 소개하고 있지만, 이게 맞는 방법인지 확신하지 못 하겠음  
> 변경에 대한 책임을 DB에게 부여하는게 맞는건지?  


## 6.2 부적절한 데이터 얽힘

데이터베이스 또는 데이터팀은 통상적인 수준보다 뒤처진 개발 도구와 엔지니어링 관행을 따르는 경우가 많다.  

> 요즘은 파이썬정도는 다 하시는 듯  

여러 팀의 관계, 자원 배분, 프로덕션 팀의 필요성 등의 요건이 복잡하게 얽혀 데이터베이스 리팩터링은 우선순위에서 멀어지곤 한다.  

> 시스템 규모가 커질 수록 컬럼 추가/삭제와 같은 DB 작업은 장애 위험성이 높아 최적화를 안하는 듯  



