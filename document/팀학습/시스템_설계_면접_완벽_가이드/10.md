# 10 데이터베이스 배치 감사 서비스 설계

데이터 품질은 데이터셋이 목적에 얼마나 적합한지를 나타내며, 그 데이터셋의 목적 적합성을 개선하는 활동을 가리킬 수도 있다.  

- 정확성: 측정값이 실제 값에 얼마나 가까운지
- 완전성: 데이터에 우리의 목적에 필요한 모든 값이 있는지
- 일관성: 다른 위치의 데이터가 동일한 값을 가지며, 다른 위치에서 동시에 동일한 데이터 변경 사항을 제공하기 시작하는지
- 유효성: 데이터가 올바르게 형식화되고 값이 적절한 범위 내에 있는지
- 고유성: 중복되거나 겹치는 데이터가 없는지
- 적시성: 필요할 때 데이터를 사용할 수 있는지

## 10.1 감사는 왜 필요한가?

늦은 복제로 인한 데이터 손실을 방지하는 한 가지 기술은 정족수 일관성이다.  

리더 호스트가 복구되면 데이터가 복구되어 다른 호스트로 복제될 수 있다.  
그러나 이는 구성에 따라 일관성을 유지하기 위해 의도적으로 리더 호스트의 데이터를 잃을 수 있는 MongoDB와 같은 특정 데이터베이스에서는 작동하지 않을 것이다.  
MongoDB 데이터베이스의 경우 쓰기 우려가 1로 설정되면 모든 노드가 리더 노드와 일관성을 가져야 한다.  

- 400 Bad Request
- 409 Conflict
- 422 Unprocessable Entity

깃허브 및 알리바바와 같은 일부 회사는 외래 키 제약을 금지한다.  

실제로는 버그와 감지되지 않는 오류가 발생할 것이다.  

> 과거 QA 환경에서 FK(타 테이블의 PK)를 임의의 값으로 셋팅한 테스트 데이터 존재  
> 시간이 흘러 FK가 현재 범위에 포함되었고, 비즈니스 로직이 수행될 때 테스트 데이터를 조작하는 헤프닝 발생  
> 잘못된 테스트 데이터로 인해 비즈니스 로직이 잘못된건지 오해함  

감사는 또 다른 유효성 검사 계층이다.  

단일 호스트가 각 행을 처리하고 검증하는 것은 너무 느리다.  
MySQL 테이블에 데이터를 저장한다면 INSERT보다 훨씬 빠른 LOAD DATA를 사용한 다음 SELECT 문을 실행해 데이터를 감사할 수 있다.  
HDFS와 같은 분선 파일 시스템을 사용한다면 병렬 처리가 가능한 하이브나 스파크와 같은 NoSQL 옵션을 사용할 수 있다.  


## 10.2 SQL 쿼리 결과에 대한 조건문으로 유효성 검사 정의

수동으로 정의된 유효성 검사에는 다음과 같은 무수히 많은 다른 가능성이 있다.  

- 테이블에 매시간 최소한의 새로운 행이 기록돼야 한다.
- 특정 문자열 열은 null 값을 포함할 수 없으며, 문자열 길이는 1 ~ 255 사이여야 한다.
- 특정 문자열 열은 특정 정규 표현식과 일치하는 값을 가져야 한다.
- 특정 정수 열은 음수가 아니어야 한다.


## 10.3 간단한 SQL 배치 감사 서비스

### 10.3.1 감사 스크립트

1. 데이터베이스 쿼리를 실행한다.
2. 결과를 변수로 읽는다.
3. 이 변수의 값을 특정 조건과 비교한다.


### 10.3.2 감사 서비스

사용자가 다음을 지정할 수 있게 스크립트를 일반화할 수 있다.  

- SQL 데이터베이스와 쿼리
- 쿼리 결과에 대해 실행할 조건

## 10.4 요구사항

- 감사 작업의 CRUD
  - 일, 시, 분 또는 사용자 지정 시간 간격
  - 소유자
  - SQL이나 HQL 유효성 검사 쿼리
  - SQL 쿼리 결과 조건문
- 실패한 작업 경보
- 과거와 현재 실행 중인 작업의 로그
- 최대 6시간 이내 완료
- DB 쿼리는 15분 이내 완료

비기능적 요구사항

- 스케일: 10,000개 미만의 작업이나, 10,000개의 데이터베이스 문
- 가용성: 고가용성은 필요 없음
- 보안: 접근 제어 필요
- 정확성: 높은 정확도 요구


## 10.5 고수준 아키텍처

배치 감사 서비스는 본질적으로 공유 배치 ETL 서비스의 래퍼다.  


### 10.5.1 배치 감사 작업 실행

배치 ETL 작업은 스크립트로 생성된다.  
사용자가 감사 작업을 생성하면, 백엔드는 그에 맞는 파이썬 스크립트를 생성할 수 있다.  

쿼리 실행 시간을 15분으로 제한하거나 쿼리 결과가 유효하지 않을 때 작업을 중단하는 등 비정상적인 쿼리의 안전장치를 만들 수 있다.  


### 10.5.2 경보 처리

경보 서비스와의 모든 상호 작용은 백엔드 서비스에서 이뤄져야 한다고 결정할 수 있다.  

- ETL과 백엔드 서비스간 책임 분리
- 유지보수

하지만 이러한 접근 방식은 잠재적인 버그를 유발할 수 있다.  
백엔드 서비스 호스트가 충돌하거나 사용할 수 없게 되면 경보가 보내지지 않을 수 있다.  

백엔드 서비스는 경보 요청을 성공적으로 보낸 후에만 200을 반환한다.  
이 접근 방식은 배치 ETL 서비스가 본질적으로 여전히 경보 요청을 하고 있으며,두 서비스를 긴민하게 결합하는 것을 의미한다.  

배치 ETL 서비스는 분할된 카프카 토픽으로 생성할 수 있고, 백엔드 서비스 호스트는 파티션에서 소비할 수 있다.  
중복 알림이 발생할 수 있다.  

대안 접근 방식은 감사 작업 결과를 SQL과 공유 로깅 서비스 모두에 기록하는 것이다.  


## 10.6 데이터베이스 쿼리 제약

배치 ETL 서비스는 실행할 수 있는 쿼리의 속도와 기간에 제약을 받아야 한다.  

- 다양한 데이터베이스 서비스가 공유 서비스다.
- 비용
- 배치 ETL 서비스의 스케줄 (중첩되면 안됨)


### 10.6.1 쿼리 실행 시간 제한

작업 구성을 생성하거나 편집할 때는 쿼리 실행 시간을 10분으로 제한하고, 작업이 실행 중일 때는 15분으로 제한하는 것이다.  
대안으로 비차단/비동기 경험을 제공할 수 있다.  

쿼리 실행이 15분을 초과하면 쿼리를 종료하고, 소유자가 쿼리를 편집하고 검증할 때까지 작업을 비활성화하며, 소유자에게 높은 긴급도의 경보를 트리거한다.  


### 10.6.2 제출 전 쿼리 문자열 확인

전체 테이블 스캔을 허용하지 않는다.  
파티션 키가 포함된 테이블에서만 쿼리를 실행할 수 있게 하고, 쿼리에는 파티션 키 필터가 포함돼야 한다.  
테이블의 파티션 키를 확인하기 위해서는 DESCRIBE 쿼리를 실행해야 한다.  
비용이 상당히 많이 들 수 있는 JOIN이 포함된 쿼리는 허용하지 않는다.  

> 배치 요구사항에 맞는 테이블(데이터)를 구성하지 않는한 불가능한게 아닌지?


### 10.6.3 초기 사용자 훈련


## 10.7 과도한 동시 쿼리 방지

배치 ETL 서비스가 실행할 수 있는 동시 쿼리 수에 제한을 설정해야 한다.  

또 다른 최적화는 배치 ETL 서비스가 데이터베이스 쿼리를 실행하기 전에 백엔드 서비스를 통해 경보 서비스에 쿼리해 해결되지 않은 경보가 있는지 확인하는 것이다.  


## 10.8 데이터베이스 스키마 메타데이터의 사용자

사용자는 감사를 통과했음에도 불구하고 동일한 감사를 다시 실행해야 할 이유가 있을 수 있다.  

테이블에는 새로운 행이 얼마나 자주 추가되는지에 대한 갱신 주기 SLA가 있을 수 있다.  

데이터베이스 메타데이터 플랫폼의 또 다른 유용한 기능은 테이블과 관련된 사건을 기록하는 것이다.  

배치 ETL 서비스는 또한 데이터베이스 스키마의 변경을 모니터링하고 그에 따라 대응할 수도 있다.  

> 스키마 변경에 따른 쿼리문 자동 변환은 오히려 위험한게 아닌지?


## 10.9 데이터 파이프라인 감사

- 상위 작업이 실패하면 감사 작업을 실행하는 것은 무의미하므로 하위 감사를 비활성화해 리소스를 절약한다.  
- 이 테이블 쿼리를 포함하는 다른 작업과 그 하위 작업도 비활성화한다.
- 모든 비활성화된 작업의 소유자와 모든 하위 작업의 소유자에게 높은 긴급도의 경보를 트리거한다.  

에어플로는 이미 사용자가 트리거 규칙을 구성해 모든 종속성이나 최소한 하나의 종속성이 성공적으로 실행을 완료할 때 각 작업이 실행되게 허용한다.  


## 10.10 로깅, 모니터링, 경보

- 작업 상태와 시간
- 실패 쿼리, 사유
- 실행 시간 초과
- P99, 4xx, 5xx 응답
- CPU, 메모리, I/O 사용률
- SQL 서비스의 높은 사용률


## 10.11 기타 감사 기능 유형

### 10.11.1 데이터 센터 간 일관성 검사

데이터 센터 간 데이터를 비교하는 샘플링 테스트를 실행할 수 있는 기능을 제공할 수 있다.  

### 10.11.2 업스트림과 다운스트림 데이터 비교

사용자가 한 테이블에서 다른 테이블로 데이터를 복사해야 할 수 있다.  
업스트림과 다운스트림 테이블의 최신 파티션을 비교해 데이터 일관성을 보장하는 감사 작업을 만들 수 있다.  


## 10.12 기타 논의 가능한 주제

- 확장 가능한 배치 ETL 서비스나 경보 서비스
  - 카프카
- 소유자가 문제를 해결 중에 동일한 쿼리를 실행하면 통과할 수 있는데 어떻게 해결하고, 어떠한 로깅이나 기능을 제공할 수 있는가?
- 동일하거나 유사한 감사 작업을 어떻게 찾고 중복을 제거할 수 있는가?



