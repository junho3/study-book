# 2장 주변 친구

근접성 서비스의 경우 사업장 주소는 정적이지만, 주변 친구 위치는 자주 바뀔 수 있기 때문이다.  

## 1단계: 문제 이해 및 설계 범위 확정

- 지리적으로 5마일 내에 있어야 하며, 이 수치는 설정 가능해야 함
- 두 사용자의 직선거리로만 가정
- 전체 10억명 중에 10% 1억명이 사용
- 사용자의 이동 이력은 보관해야 함
- 10분 이상 비활성 상태이면, 친구 목록에서 사라지도록 함
- GDPR, CCPA 같은 개인정보보호법은 생각하지 않기로 함

### 기능 요구사항

### 비기능 요구사항

- 낮은 지연 시간: 친구 위치가 빠르게 반영되야 한다.
- 안정성
- 결과적 일관성: 위치 데이터를 저장하기 위해 강한 일관성을 지원하는 데이터 저장소를 사용할 필요는 없다.

### 개략적 규모 추정


## 2단계: 개략적 설계안 제시 및 동의 구하기

위치 정보를 모든 친구에게 전송해야 하는 요구사항 때문에 HTTP 프로토콜을 사용하지 못 할 수 있다.  

### 개략적 설계안

이론적으로 사용자 근처의 모든 친구의 단말과 연결하는 P2P 방식을 생각할 수 있지만, 모바일 단말은 통신 상태가 좋지 않고, 전력도 충분하지 않다.  
공용 백엔드 서버가 중계해줘야 한다.  
동시 접속자가 천만명에 30초마다 갱신했을 때 초당 334,000번의 위치 정보 갱신을 해야하며, 큰 규모에 대응 할 수 없다.  

### 설계안

#### 로드밸런서

#### RESTful API

사용자와 친구 관리, 인증 및 기타 기능

#### 웹소켓 서버

친구 위치 정보 변경을 거의 실시간에 가깝게 처리  
각 클라이언트는 한 대의 웹소켓 연결을 지속적으로 유지한다.  

#### 레디스 위치 정보 캐시

레디스는 활성 상태 사용자의 가장 최근 위치 정보를 개시하는 데 사용한다.  
TTL 설정으로 캐시의 생명주기를 관리  

#### 사용자 데이터베이스

#### 위치 이동 이력 데이터베이스



