# 1장 쿼리 응답 시간

성능은 곧 쿼리 응답 시간입니다.  
쿼리 응답 시간은 MySQL이 쿼리를 실행하는 데 소요되는 시간입니다.


## 1-1 거짓 성능에 관한 실화

당시에는 MySQL에 관한 책이나 블로그, 도구가 거의 없었습니다.  
결과적으로 MySQL 성능 문제를 해결하기 위한 최신 기술은 고객에게 더 많은 램을 판매하는 것뿐이었습니다.  

저는 중요한 인덱스가 없는 단일 쿼리를 발견했고 쿼리를 제대로 인덱싱하자 성능이 획기적으로 향상되며 웹 사이트가 살아났습니다.  

> 비슷한 경험이 있음  
> 배치에서 성능이 안나와서 전체 프로세스를 다시 구성했는데, 이후에 알고보니 인덱스가 안걸려 있어서 성능이 안나왔다는 점  


## 1-2 핵심 지표(North Star)

### 의미있는 것

쿼리 응답 시간은 누구나 진정으로 관심을 가지는 유일한 메트릭입니다.  

### 실행 가능한 것

결국 여러분은 MySQL 성능에서 핵심 지표인 쿼리 응답 시간 향상에 집중해야 합니다.  
하드웨어 문제로 돌리면 안 됩니다.  
MySQL이 시작되면 먼저 쿼리 메트릭으로 MySQL이 수행하는 작업을 확인한 다음 느린 쿼리를 분석하고 최적화하여 응답 시간을 단축해야 합니다.  

> DBA가 슬로우 쿼리를 체크하고, 개발자에게 개선하도록 요구하는 중  
> 담당하고 있는 정산, 대사 시스템이 10초내에 처리하는 것을 목표로 하는 중 (피트니스 함수)  
> 대량 데이터 인서트 / 조회를 Jpa에서 Exposed로 구현  


## 1-3 쿼리 보고

쿼리 메트릭은 응답 시간, 잠금 시간, 조회된 행 등 쿼리 실행에 관하여 중요한 통찰력을 제공합니다.  

### 소스

쿼리 메트릭은 **슬로 쿼리 로그**나 **성능 스키마**에서 비롯됩니다.  
슬로 쿼리 로그는 디스크에 있는 로그 파일이고, 성능 스키마는 performance_schema와 같은 이름의 데이터베이스입니다.  
둘 다 쿼리 메트릭을 제공합니다.  
주요 차이점은 얼마나 많은 메트릭을 제공하는지입니다.  
둘 다 쿼리 응답 시간을 제외하고 3~20개 이상의 메트릭을 제공합니다.  

- 슬로 쿼리
  - 로그 파일
  - 기본으로 비활성화
  - MySQL 재부팅 없이 활성화 가능
- 성능 스키마
  - performance_schema와 같은 이름의 데이터베이스
  - 기본으로 활성화지만, 일부 클라우드에서는 비활성화
  - MySQL을 재부팅해야 활성화 가능

### 집계

몇몇 쿼리 메트릭 도구는 사용자 이름, 호스트 이름, 데이터베이스 등으로 그룹화할 수 있습니다.  

```
쿼리를 SHA-256 해시로 변환하여 고유하게 식별 가능
SQL문: SELECT col FROM tbl WHERE id = 1
다이제스트 텍스트: SELECT `col` FROM `tbl` WHERE `id` = ?
다이제스트 해시 (SHA-256): f49d50dfab1.....
```
`EXPLAIN` 명령어를 사용하면 쿼리 실행을 이해하는데 필요한 메타데이터를 생성할 수 있으므로 쿼리 분석에 샘플이 필요합니다.  
일부 쿼리 메트릭 도구는 샘플을 EXPLAIN한 다음 폐기하고 EXPLAIN 계획(결과)를 보고합니다.  

```  
SELECT name FROM captains WHERE last_name = 'Picard'
SELECT name FROM captains WHERE last_name = 'Picard' AND first_name = 'Jean-Luc'
```
두 쿼리는 결과가 같을 수 있으나, 서로 다른 다이제스트로 정규화되므로 보고 측면에서는 서로 다른 쿼리입니다.  
특히 `WHERE`절은 쿼리 실행과 최적화에 영향을 미치므로 별도로 이 쿼리들을 보고하는 것이 기술적으로 옳습니다.  

```  
SELECT name FROM star_ships WHERE class IN ('galaxy')
SELECT name FROM star_ships WHERE class IN ('galaxy', 'intrepid)

SELECT name FROM star_ships WHERE class IN (...)
```
쿼리 정규화에서 한 가지 알아야 할 점은 값이 제거되므로 다음 두 쿼리는 같은 다이제스트로 정규화된다는 사실입니다.  

### 보고

또한 각 쿼리에는 샘플, EXPLAIN 계획, 테이블 구조 등의 메타데이터가 있습니다.  
거의 모든 쿼리 메트릭 도구는 쿼리 프로파일과 쿼리 보고서라는 2가지 수준의 계층 구조로 데이터를 제공합니다.  

#### 쿼리 프로파일

쿼리 프로파일에 느린 쿼리가 표시됩니다.  
쿼리 시간을 기준으로 쿼리를 정렬하면 가장 느리고 시간이 오래 걸리는 쿼리부터 확인할 수 있습니다.  

#### 쿼리 총시간

쿼리 총시간은 실행 시간의 총합입니다.  
응답시간 1초에 10번 실행되는 쿼리 A와 응답시간 0.1초에 1,000번 실행되는 쿼리 B가 있을 경우 쿼리 총시간은 B가 더 크기 때문에 B를 최적화시켜야 한다.  

#### 실행 시간 비율

실행 시간 비율은 쿼리 총시간을 실행 총시간으로 나눈 값이다.  
321ms 쿼리 C와 100ms 쿼리 D가 있을 때 쿼리 C의 비중은 76.2%이므로 가장 느린 쿼리는 C이다.  

#### 쿼리 부하

쿼리 부하는 쿼리 총시간을 클럭 타임으로 나눈 것으로, 클럭 타임은 시간 범위에 대한 전체 초 수입니다.  
부하는 시간과 관련이 있지만 동시에 실행되는 쿼리의 다중 인스턴스와 같은 동시성을 미묘하게 나타내기도 합니다.  
쿼리 부하가 평균적으로 1.0보다 작으면 쿼리가 동시에 실행되지 않습니다.  
쿼리 부하가 1.0보다 크면 쿼리 동시성을 나타냅니다.  
예를 들어, 쿼리 부하가 3.5라는 것은 "언제든지 조회하면 실행 중인 쿼리의 인스턴스가 3.5개 정도 있다"라는 의미입니다.  
쿼리 부하가 높을수록 쿼리가 동일하거나 가까운 행에 접근할 때 경합할 가능성이 커집니다.  


### 쿼리 보고서

쿼리 보고서는 하나의 쿼리에 대해 알아야 할 모든 것을 보여줍니다.  
일반적으로 쿼리 프로파일에서의 느린 쿼리를 선택하는 것으로 시작합니다.  
쿼리 보고서는 쿼리 분석에 사용되는 많은 정보로 구성되어 있습니다.  

만약 사용하는 쿼리 메트릭 도구가 쿼리 메트릭만 보고한다면 최소한 EXPLAIN 계획과 테이블 구조를 수동으로 수집하는 것부터 시작해야 합니다.  




