# 14장 유튜브 설계

## 1단계 문제 이해 및 설계 범위 확정

- 비디오 업로드와 시청
- 모바일 앱, 웹, 스마트 TV
- 일 5백만 이용자
- 평균 30분 시청
- 다국어 지원
- 모든 비디오 해상도 지원 필요
- 암호화 필요
- 비디오 파일은 최대 1GB 제한
- 클라우드 활용 가능

### 개략적 규모 추정

- 매일 필요한 저쟝 용량 150TB
- CDN 비용

## 2단계 개략적 설계안 제시 및 동의 구하기

```
Blob 스토리지는 비정형 데이터를 위한 클라우드 스토리지 유형입니다. 
Binary Large Object의 줄임말인 "blob"은 파일 형식을 반드시 따를 필요는 없는 이진 형식의 데이터 덩어리입니다. 
blob 스토리지는 이러한 대량의 데이터를 데이터 레이크라고 하는 비계층적 스토리지 영역에 보관합니다.
https://www.cloudflare.com/ko-kr/learning/cloud/what-is-blob-storage/
```

### 비디오 업로드 절차

1. 원본 저장소에 파일 업로드
2. 트랜스코딩 서버에서 파일 변환
3. 변환된 파일은 비디오 저장소로 이동
4. 트랜스 코딩 완료를 큐에 넣음
5. 트랜스코딩 완료 핸들러가 메타데이터 업데이트

> 원본 저장소에 파일 업로드 후 바로 트랜스코딩 서버를 호출하기보다 중간에 큐를 두는게 좋지 않을까?  
> 파일 인코딩은 리소스를 많이 먹음  

#### 프로세스 A: 비디오 업로드

#### 프로세스 B: 메타데이터 갱신

### 비디오 스트리밍 절차

스트리밍 프로토콜
- MPEG-DASH
- 애플 HLS
- 마이크로소프트 스무드 스트리밍
- 어도비 HTTP 동적 스트리밍

## 3단계 상세 설계

### 비디오 트랜스코딩

- 가공되지 않은 원본 비디오는 저장 공간을 많이 차지한다.  
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다.  
- 네트워크 대역폭에 따라 저화질과 고화질을 전송해야 한다.
- 모바일 단말은 네트워크가 끊길 수 있다.


- 컨테이너: .avi, .mov, .mp4 비디오 파일, 오디오, 메타데이터 보관
- 코덱: 비디오 화질을 보존하면서 파일 크기를 줄일 목적의 압축 알고리즘

### 유향 비순환 그래프(DAG) 모델

각기 다른 유형의 비디오 프로세싱 파이프라인을 지원해야 함  
처리 과정의 병렬성을 높이기 위해서 적절한 수준의 추상화를 도입해야 함  
유향 비순환 그래프 프로그래밍 모델을 도입하여, 작업을 단계별로 배열할 수 있도록 함  
해당 작업들이 순차적으로 또는 병렬적으로 실행될 수 있도록 함

- 검사
- 비디오 인코딩
- 썸네일
- 워터마크

#### 전처리기

- 비디오 부할
- DAG 생성
- 데이터 캐시

#### DAG 스케줄러

```
DAG(Directed Acyclic Graph)는 순환그래프가 아닌 비순환 그래프입니다.  
즉, DAG알고리즘에서는 순환하는 싸이클이 존재하지 않고, 일방향성만 가진다는 것이죠.  
https://steemit.com/dag/@cryptodreamers/dag-dag-directed-acyclic-graph
```

> Airflow DAG

#### 자원 관리자

큐를 사용하여 작업 단위를 나누고, 병렬 처리를 제공

#### 작업 서버

#### 임시 저장소

메타 데이터는 메모리에 캐시  
비디오, 오디오 데이터는 BLOG 저장소에 보관  

#### 인코딩된 비디오

### 시스템 최적화

#### 속도 최적화: 비디오 병렬 업로드

하나의 비디오를 GOP들로 분할하여 병렬로 업로드  

#### 속도 최적화: 업로드 센터를 사용자 근거리에 지정

#### 속도 최적화: 모든 절차를 병렬화

각 구간별로 메세지 큐를 두어서 병렬 처리하도록 함  

#### 안전성 최적화: 미리 사인된 업로드 URL

```
미리 서명된 URL을 사용하여 다른 사람이 Amazon S3 버킷에 객체를 업로드하도록 허용할 수 있습니다. 
미리 서명된 URL을 사용하면 상대방에게 AWS 보안 자격 증명이나 권한이 없어도 업로드할 수 있습니다. 
미리 서명된 URL은 이를 생성하는 사용자의 권한에 따라 제한됩니다.

https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/PresignedUrlUploadObject.html
```

#### 안전성 최적화: 비디오 보호

- 디지털 저작권 관리 DRM 시스템 도입
- AES 암호화
- 워터마크

#### 비용 최적화

유튜브 비디오 스트리밍은 롱테일 분포를 따른다.  
인기 있는 비디오는 번번히 재생되는 반면, 나머지는 거의 보는 사람이 없다는 것이다.
인기 있는 비디오는 CDN에 올리고, 인기 없는 비디오는 비디오 서버에서 제공하도록 함  

#### 오류 처리

- 회복 가능 오류: 트랜스코딩 진행 도중 실패
- 회복 불가능 오류: 비디오 포맷이 잘못되는 경우

## 4단계 마무리

- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍
- 비디오 삭제
