# 구글 맵

구글 맵은 위성 이미지, 거리뷰, 실시간 교통 상황, 경로 계획 등 다양한 서비스를 제공하고 있다.  
2021년 3월 구글 맵 일간 능동 사용자 수는 10억명이다.  
정확한 실시간 위치 정보를 제공하기 위해 매일 2500만 건의 업데이트를 반영한다.  
구글 맵은 엄청나게 복잡한 제품이므로, 설계에 앞서 어떤 기능에 초점을 맞추어야 하는지 확인해야 한다.  

## 1단계: 문제 이해 및 설계 범위 확정

- 일간 능동 사용자 수는 10억
- 위치 갱신, 경로 안내, ETA(예상 도착 시간), 지도 표시에 초점을 맞춤
- 수 TB의 가공되지 않은 데이터를 확보했다고 가정
- 교통 상황을 고려해야 함
- 다양한 이동 방법을 지원해야 함
- 경유지를 여러 곳 설정하는 것은 제외
- 사업장 위치나 사진은 제외

### 기능 요구사항

### 비기능 요구사항 및 제약사항

- 지도 및 경로 정확도
- 부드로운 경로 표시
- 모바일 단말을 위한 최소한의 데이터 및 배터리 사용량
- 일반적인 가용성 및 규모 확장성

### 지도 101

#### 측위 시스템

위도와 경도 기반

#### 3차원 위치의 2차원 변환

3차원 구 위의 위치를 2차원 평면에 대응시키는 절차를 '지도 투영법' 또는 '도법'이라 한다.  
구글 맵은 메르카토르 도법을 조금 변경한 웹 메르카토르 도법을 택하고 있다.  

#### 지오코딩

지오코딩은 주소를 지리적 측위 시스템의 좌표(위도, 경도)로 변환하는 프로세스다.  

#### 지오해싱

지오해싱은 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계다.  
2차원 평면 공간으로 표현된 지리적 영역 위의 격자를 더 작은 격자로 재귀적으로 분할해 나간다.  

> 1,2 장에서는 '지오해시'라고 표현하는데, 차이는 없는 듯  

#### 지도 표시

지도 전부를 하나의 이미지로 표시하는 대신, 작은 타일로 쪼개어 표시  
지도의 확대/축소를 지원하려면 확대 수준에 따라 다른 종류의 타일을 준비해야 한다.  

#### 경로 안내 알고리즘을 위한 도로 데이터 처리

대부분의 경로 탐색 알고리즘은 데이크스트라나 A* 경로 탐색 알고리즘의 변종이다.  

> 데이크스트라 알고리즘  
> https://ko.wikipedia.org/wiki/%EB%8D%B0%EC%9D%B4%ED%81%AC%EC%8A%A4%ED%8A%B8%EB%9D%BC_%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98  
> https://velog.io/@717lumos/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98-%EB%8B%A4%EC%9D%B5%EC%8A%A4%ED%8A%B8%EB%9D%BCDijkstra-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98  
>
> A* 알고리즘
> https://ko.wikipedia.org/wiki/A*_%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98

대부분의 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 아주 민감하다.  
전 세계 도로망을 하나의 그래프로 표현하면 메모리도 많이 필요하고, 경로 탐색 성능도 만족스럽지 않을 것이다.  

지오해싱과 비슷한 분할 기술을 적용하여 세계를 작은 격자로 나누고, 각 격자 안의 도로망을 노드(교차로)와 선(도로)으로 구성된 그래프 자료 구조로 변환한다.  
각 타일은 도로로 연결된 다른 타일에 대한 참조를 유지한다.  

경로 안내 타일로 분할해 놓으면 경로 탐색 알고리즘이 동작하는 데 필요한 메모리 요구량을 낮출 수 있을 뿐 아니라 한번에 처리해야 하는 경로의 양이 줄어들고, 필요한 만큼만 불러오면 되기 때문에 경로 탐색 성능도 좋아진다.  

> 지도 서비스는 어떻게 만드는 것일까?  
> https://d2.naver.com/helloworld/1174
> 
> 카카오맵이 빠르게 길을 찾아주는 방법: CCH를 이용한 개편기  
> https://tech.kakao.com/2021/05/10/kakaomap-cch/
>
> 카카오맵 VS 네이버지도 | 대중교통 알고리즘은 누가 좋을까?  
> https://emusk.tistory.com/275  
> 
> 성남에서 종로 갈 때 버스 1번만 환승해도 갈 수 있지만, 네이버지도에서는 2번 환승하라고 안내하고 있어서 개선 요청을 해본 경험이 있음  
> 동일한 목적지인데도 네이버 웹의 지도 경로 안내와 네이버지도 앱의 경로 안내가 다름  

#### 계층적 경로 안내 타일

경로 안내가 효과적으로 동작하려면 필요한 수준의 구체성을 갖춘 도로 데이터가 필요하다.  
구체성 정도를 상, 중, 하로 구분하여 세 가지 종류의 경로 안내 타일을 준비한다.  

- 상: 구체성이 가장 높아 타일 크기가 아주 작고, 지방 도로 데이터만 둔다.  
- 중: 규모가 비교적 큰 관할구를 잇는 간선 도로 데이터만 둔다.  
- 하: 타일 크가가 가장 크고, 도시와 주를 연결하는 주요 고속도로 데이터만 둔다.  




