# 4장 가상 머신 성능 모니터링과 문제 해결 도구

## 4.1 들어가며

## 4.2 기본적인 문제 해결 도구

이 도구들은 라이선스와 성숙 수준에 따라 다음 세 범주로 나눌 수 있다.  
- 상용 인증 도구
- 공식 지원 도구
- 실험적 도구

도구들을 자바로 구현한 데는 이유가 있다.  
애플리케이션이 프로덕션 환경에 배포되면 서버에 물리적으로 직접 접근하거나 SSH 등으로 원격 접속하는 데 제약이 있을 수 있다.  
이럴 경우라도 개발자는 JDK 도구 라이브러리의 인터페이스와 구현 코드를 이용하여 강력한 모니터링과 분석 기능을 애플리케이션에서 직접 제공할 수 있다.  

대체로 상위 버전 JDK의 도구들은 하위 버전 JDK의 가상 머신에서 구동되는 프로그램과 호환되며 반대도 마찬가지다.  

### 4.2.1 jps: 가상 머신 프로세스 상태 도구

동작 중인 가상 머신 프로세스 목록을 보여 주며 각 프로세스에서 가상 머신이 실행한 메인 클래스의 이름과 로컬 가상 머신 식별자(LVMID)를 알려준다.  
대다수 다른 JDK 도구에서 모니터링할 가상 머신 프로세스를 명시하려면 LVMID를 알아야 하기 때문이다.  

로컬 가상 머신 프로세스의 LVMID 값은 운영 체제의 프로세스 아이디, 즉 PID와 같다.  

```
~ ❯ jps -l
1536 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli
1846 jdk.jcmd/sun.tools.jps.Jps
1415 com.intellij.idea.Main
```

### 4.2.2 jstat: 가상 머신 통계 정보 모니터링 도구

- 로컬 또는 원격 가상 머신 프로세스의 클래스 로딩
- 메모리
- 가비지 컬렉션
- JIT 컴파일

```
~ ❯ jstat -gc 1415 250 20    
S0C         S1C         S0U         S1U          EC           EU           OC           OU          MC         MU       CCSC      CCSU     YGC     YGCT     FGC    FGCT     CGC    CGCT       GCT
0.0     10240.0         0.0      9600.3     296960.0      95232.0     331776.0     304067.9   341312.0   337079.5   42432.0   40606.8     57     0.760     0     0.000    36     0.348     1.108
```

jstat은 가상 머신 상태 정보를 텍스트로만 보여 주어 VisualVM이나 JMC처럼 시각적으로 보여 주는 모니터링 도구보다 직관적이지 않다.  

### 4.2.3 jinfo: 자바 설정 정보 도구

jinfo는 가상 머신의 다양한 매개 변수를 실시간으로 확인하고 변경하는 도구다.  

```
~ ❯ jinfo -flag ConcGCThreads 1415
-XX:ConcGCThreads=2
```

### 4.2.4 jmap: 자바 메모리 매핑 도구

jmap은 힙 스냅숏을 파일로 덤프해 주는 자바용 메모리 맵 명령어다.  
힙 스냅숏 덤프 외에도 jmap으로 F-큐, 자바 힙과 메서드 영역 상세 정보도 알아낼 수 있다.  

```
~ ❯ jmap -histo 1415
```

### 4.2.5 jhat: 가상 머신 힙 덤프 스냅숏 분석 도구

jhat은 JDK 8까지 제공되던 JVM 힙 분석 도구로, jmap으로 덤프한 힙 스냅숏을 분석할 수 있다.  
JDK 9부터 jhsdb가 그 자리를 대신한다.  

실무에서 jhat을 직접 사용해 분석하는 사람은 많지 않다.  
- 힙 스냅숏 덤프를 애플리케이션이 배포된 서버에서 직접 분석하는 일은 드물다.
- jhat의 분석 기능은 단순한 편이다.  

### 4.2.6 jstack: 자바 스택 추적 도구

jstack은 현재 가상 머신의 스레드 스냅숏을 생성하는 데 쓰인다.  
스레드 스냅숏은 현재 가상 머신에서 실행 중인 각 스레드의 메서드 스택들의 집합이다.  
주로 스레드가 장시간 멈춰 있을 때 원인을 찾기 위해 생성한다.  

```
~ ❯ jstack -l 1415
```

### 4.2.7 기본 도구 요약


## 4.3 GUI 도구

- JConsole
- JHSDB
- VisualVM
- JMC

### 4.3.1 JHSDB: 서비스 에이전트 기반 디버깅 도구

JHSDB는 SA를 통해 프로세스 외부에서 디버깅할 수 있는 도구다.  
SA는 핫스팟 가상 머신이 제공하는 API 집합으로, 자바 가상 머신의 런타임 정보를 제공한다.  

```
로컬 환경에서 시도했을 때 HSDB는 실행되는데, pid를 찾을 수 없거나 권한이 없다는 에러 발생

sudo jhsdb hsdb --pid 2135
2024-12-15 11:28:12.569 jhsdb[2181:72403] +[IMKClient subclass]: chose IMKClient_Modern
2024-12-15 11:28:12.569 jhsdb[2181:72403] +[IMKInputSession subclass]: chose IMKInputSession_Modern
ERROR: attach: task_for_pid(2135) failed: '(os/kern) failure' (5)
```

### 4.3.2 JConsole: 자바 모니터링 및 관리 콘솔

JConsole은 JMX에 기반한 GUI 모니터링 및 관리 도구다.  
JMX는 가상 머신 자체는 물론 가상 머신에 구동되는 소프트웨어를 관리하는 용도다.  
공개 기술이라서 모니터링과 관리 기능을 제공하는 미들웨어들은 대체로 JMX를 이용한다.  

#### JConcole 실행

#### 메모리 모니터링

```
JConcole에서는 pid가 확인이 되고, 책 내용과 동일하게 모니터링이 가능했음  
```

#### 스레드 모니터링

스레드가 장시간 멈춰 있는 주된 원인은 데이터베이스 연결, 네트워크, 디바이스 등 외부 자원 대기 또는 무한 루프나 락 대기 등이라고 했다.  

교착 상태를 일으키는 근본 원인은 Integer.valueOf() 메서드의 구현 방식에 있다.  
이 메서드는 생성되는 객체 수를 줄여 메모리를 절약하기 위해 -128 ~ 127 사이인 Integer 객체를 캐시해서 쓰도록 구현되었다.  

```
예전에 Integer 캐싱의 == 관련 장애 글을 본 기억이 있음  
https://mangkyu.tistory.com/273  
```

스레드 A는 스레드 B가 소유한 Integer.valueOf(1)을 기다리고, B는 A가 소유한 Integer.valueOf(2)를 기다리게 된다.  
결국 두 스레드 모두 실행되지 못한다.  

```
컬리 재고 차감 시 데드락 발생 원인과 유사한 듯  
https://helloworld.kurly.com/blog/vsms-performance-experiment/#%EA%B0%80%EC%9E%A5-%EA%B0%84%EB%8B%A8%ED%95%9C-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-%EC%A0%95%EB%A0%AC
```


### 4.3.3 VisualVM: 다용도 문제 대응 도구

VisualVM은 일반적인 운영 및 문제 대응 기능에 더해 성능 분석까지 제공하는 올인원 자바 문제 해결 도구다.  
VisualVM은 모니터링 대상 프로그램에 특별한 에이전트 소프트웨어를 심지 않아도 돼서 활용하기 쉽고 애플리케이션 성능에 미치는 영향도 적다.  

#### VisualVM 설치 및 실행

#### 플러그인 설치

#### 힙 스냅숏 덤프 생성하고 둘러보기

#### 프로그램 성능 분석하기

#### BTrace 동적 로그 추적하기

BTrace는 핫스팟 가상 머신의 인스트루먼트 기능을 이용하여 원래 코드에 없던 디버깅 코드를 동적으로 삽입할 수 있다.  
더구나 이 디버깅 코드는 대상 프로그램의 동작에 간섭하지 않기 때문에 운영 중인 프로그램에 매우 유용하다.  

- 콜 스택, 매개 변수, 반환값 출력
- 성능 모니터링
- 연결 누수나 메모리 누수
- 스레드 경합 문제 해결

### 4.3.4 JMC: 지속 가능한 온라인 모니터링 도구

- AMC: 기업용 JRE 맞춤 관리
- JUT: 시스템에서 JRE 사용 현황 추적
- JFR: 지속적인 데이터 수집
- JMC: 자바 가상 머신 모니터링

JFR은 핫스팟 가상 머신에 내장된 모니터링 및 이벤트 기반 정보 수집 프레임워크다.  
- 상시 구동
- 성능 오버헤드 0
- 애플리케이션 재시작 없이 언제든 켜고 끌 수 있음
- 애플리케이션 소스 코드를 수정할 필요 없음
- 특정 에이전트를 함께 구동할 필요 없음
- 연속된 이벤트들을 기록하는 방식

JMC는 단독으로 실행하기보다는 이클립스 플러그인 형태로 쓰이는 모습을 더 흔히 볼 수 있다.  
- JMC와 가상 머신의 통신에는 JMX 프로토콜 사용
- 가상 머신 메모리나 파일로부터 이벤트 데이터를 읽어 와 보여주고 성능 분석


## 4.4 핫스팟 가상 머신 플러그인과 도구

- IGV
- CCV
- 프로젝트 크리에이터
- LongCompliation
- HSDIS

### 4.4.1 HSDIS

JIT 컴파일러가 엄청난 양의 실행 코드를 동적으로 생성해 코드 캐시에 추가하는데, 이런 혼재된 환경에서 쉽게 디버깅할 간단한 방법은 없다.  
HSDIS는 오라클이 권장하는 핫스팟 가상 머신 JIT 컴파일 코드용 디스어셈블리 플러그인이다.  

핫스팟의 JIT 컴파일러가 동적으로 생성한 네이티브 코드를 HSDIS가 어셈블리 코드로 복원해 출력한다.  

### 4.4.2 JITWatch

JITWatch는 핫스팟 JIT 컴파일러용 로그 분석 및 시각화 도구로, HSDIS와 자주 함께 쓰인다.  


## 4.5 마치며

`자바 가상 머신 명세` 자체는 모니터링이나 문제 해결 방법을 정의하고 있지 않으므로 도구에 따라 지원하는 가상 머신과 기능 범위가 다를 수 있다.  
따라서 핫스팟 외의 가상 머신을 이용하는 독자라면 적합한 분석 도구를 선택하는 게 특히 중요하다.  

