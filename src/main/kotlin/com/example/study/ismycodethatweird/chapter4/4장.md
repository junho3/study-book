# 4장 불변 활용하기: 안정적으로 동작하게 만들기

가변과 불변을 적절하게 설계하지 못하면 동작을 예측하기 어렵고 혼란스러워진다.  
이러한 악마를 퇴치하려면, 가능한 한 상태가 변경되지 않도록 설계해야 한다.  


## 4.1 재할당

변수에 값을 다시 할당하는 것을 재할당 또는 파괴적 할당이라고 한다.  
재할당은 변수의 의미를 바꿔 추측하기 어렵게 만든다.  

### 4.1.1 불변 변수로 만들어서 재할당 막기

변수에 final 수식자를 붙여 재할당을 막는다.  

### 4.1.2 매개변수도 불변으로 만들기


## 4.2 가변으로 인해 발생하는 의도하지 않은 영향

인스턴스가 가변이면 다른 부분에 의도하지 않은 영향을 주기 쉽다.  

### 4.2.1 사례 1: 가변 인스턴스 재사용하기

> 코드 4.9에서 weaponA.attackPower.value = 25;와 같이 Weapon 객체를 통해서 AttackPower의 value를 수정하는건 이상해보임  

### 4.2.2 사례 2: 함수로 가변 인스턴스 조작하기

예상하지 못한 동작은 함수(메서드) 때문에 발생하기도 한다.  

### 4.2.3 부수 효과의 단점

함수의 부수 효과는 '함수가 매개변수를 전달받고, 값을 리턴하는 것' 이외에 외부 상태(인스턴스 변수 등)를 변경하는 것을 가리킨다.  

동일한 결과를 내기 위해서는 동일한 순서로 실행해야 한다.  
즉, 작업 실행 순서에 의존하게 되는 것이다.  
이런 코드는 결과를 예측하기 힘들며, 유지 보수하기 힘들다.  

파일을 읽는 중에 내용이 변경될 수도 있다.  
그래서 항상 같은 결과가 나온다고 보장할 수 없다.  

함수 내부에 선언하 지역 변수의 변경은 부수 효과라고 말할 수 없다.  
함수 외부에 영향을 주지 않기 때문이다.  

### 4.2.4 함수의 영향 범위 한정하기

함수는 다음 항목을 만족하도록 설계하는 것이 좋다.  
- 데이터(상태)는 매개변수로 받는다.
- 상태를 변경하지 않는다.
- 값은 함수의 리턴 값으로 돌려준다.  

따라서 매개변수로 상태를 받고, 상태를 변경하지 않고, 값을 리턴하기만 하는 함수가 이상적이다.  

### 4.2.5 불변으로 만들어서 예기치 못한 동작 막기

기능 변경 때에 의도하지 않게 부수 효과가 있는 함수가 만들어져서, 예상하지 못한 동작을 일으킬 가능성은 항상 존재 한다.  

> Code_4_18.kt 참고


## 4.3 불변과 가변은 어떻게 다루어야 할까

### 4.3.1 기본적으로 불변으로

변수를 불변으로 만들면 다음과 같은 장점이 있다.  
- 변수의 의미가 변하지 않으므로, 혼란을 줄일 수 있음
- 동작이 안정적이게 되므로, 결과를 예측하기 쉬움
- 코드의 영향 범위가 한정적이므로, 유지 보수가 편리해짐

> 불변으로 객체/변수를 선언하는 것은 동의  
> 하지만, 가변이 필요할 때마다 새로운 객체를 만드는게 맞는건지 생각해봐야 할 듯  
> 메모리나, 성능 영향이 있지 않을까  

### 4.3.2 가변으로 설계해야 하는 경우

성능이 중요한 경우 가변이 필요한 경우도 있다.  
크기가 큰 인스턴스를 새로 생성하면서 시간이 오래 걸려 성능에 문제가 생긴다면, 불변보다는 가변을 사용하는게 좋다.  

### 4.3.3 상태를 변경하는 메서드 설계하기

상태를 변화시키는 메서드를 '뮤테이터'라고 한다.

> Code_4_24.kt 참고

### 4.3.4 코드 외부와 데이터 교환은 국소화하기

코드를 아무리 주의 깊게 작성하더라도, 파일이나 데이터베이스는 코드 외부에 있는 상태이다.  
코드 내부에서는 이러한 외부 동작을 제어할 수 없다.  
특별한 이유 없이 외부 상태에 의존하는 코드를 작성하면, 동작 예측이 힘들어지므로 문제가 발생할 가능성이 높아진다.  

리포지터리 패턴은 데이터베이스의 영속화를 캡슐화하는 디자인 패턴이다.

