# 13 콘텐츠 배포 네트워크 설계하기

## 13.1 CDN의 장점

### 13.1.1 CDN 사용의 장점

- 낮은 지연 시간
  - 낮은 지연 시간은 SEO (검색 엔진 최적화) 개선 가능
  - 여러 데이터 센터 모니터링의 복잡성
- 확장성
- 낮은 단위 비용
- 높은 처리량
  - 많은 사용자와 높은 부하를 처리할수록 비용 감소
- 높은 가용성
  - 자사 서비스의 호스트가 실패할 때 대체 수단으로 적용 가능
  - 트래픽 급증 시 다른 데이터 센터로 리다이렉션 가능


### 13.1.2 CDN 사용의 단점

- 복잡성
  - 추가적인 DNS 조회
  - 추가적인 실패 지점
- 트래픽이 적을 경우 높은 비용
- 다른 CDN으로 마이그레이션 어려움
  - 특정 지역의 서비스 미제공
  - 폐업
  - 낮은 퀄리티
- 일부 국가나 조직이 특정 CDN IP 차단 가능성
- 보안과 프라이버시 문제


### 13.1.3 이미지 제공 CDN을 사용할 때 발생할 수 있는 예상치 못한 문제의 예

CDN은 GET 요청의 User-Agent 헤더를 읽어 요청이 웹 브라우저에서 온 것인지 확인하고, 업로드 된 PNG나 JPEG 대신 WebP 이미지를 반환할 수 있다.  
일부 서비스에서는 이상적일 수 있지만, 원본 형식으로 이미지를 반환받고자 하는 다른 브라우저 애플리케이션에서는 세 가지 선택지가 있다.  

> WebP 단점 (GPT 답변)
> - 오래된 브라우저의 미지원
> - 구형 기기에서 WebP 디코딩 진행 시 높은 CPU 연산과 베터리 소모를 요구하게 됨
> - 낮은 투명도 품질


1. 웹 애플리케이션에서 User-Agent 헤더 재정의
2. 서비스별로 서로 다른 이미지를 제공하도록 CDN 구성
3. 백엔드 서비스를 통한 라우팅


## 13.2 요구사항

- 기능 요구사항
  - 권한 있는 사용자는 디렉토리 생성
  - 10GB 크기 제한의 파일 업로드
  - 파일 다운로드
- 비기능 요구사항
  - 확장성
    - 페타바이트 규모의 저장 용량
    - 하루 테라바이트 수준의 다운로드 용량
  - 고가용성
  - 고성능
    - 가장 빠른 다운로드 속도
    - 동기화는 시간이 필요하므로 업로드 성능은 덜 중요함
  - 내구성
    - 파일이 손상돼서는 안 됨
  - 보안과 프라이버시


## 13.3 CDN 인증과 권한 부여

- 인증: 사용자 식별
- 인가: 사용자의 리소스 권한 식별
- 핫링킹: 사이트나 서비스 허가 없이 CDN 자산에 접근하는 것


- 쿠키 기반 인증
- 토큰 기반 인증
  - 메모리를 덜 사용함
  - IP 주소나 특정 사용자 계정으로 제한 가능

### 13.3.1 CDN 인증과 권한 부여 단계

클라이언트/사용자가 CDN에 HTTP 요청을 할 때는 CDN 사용 업체의 URL을 레퍼러 HTTP 헤더로 포함해야 한다.  
CDN은 승인된 레퍼러만 허용하므로 이는 승인되지 않은 레퍼러가 CDN을 사용하는 것을 막는다.  

하지만 이것은 적절한 보안 체계가 아니다.  
클라이언트는 레퍼러 헤더를 쉽게 위조할 수 있다.  

### 13.3.2 키 교체

피해를 제한하기 위해 고객의 키를 주기적으로 변경할 수 있다.  
새 키가 고객의 모든 시스템에 전파되는 데 시간이 걸리므로 그동안 고객은 이전 키와 새 키를 모두 계속 사용할 수 있다.  

> 옮긴 회사마다 꼭 한번쯤 키 만료로 인한 장애는 발생하는 듯  
> 팀캘린더에 1년에 한번 모든 키(인증서) 만료 확인하는 날을 등록함  


## 13.4 상위 수준 아키텍처

- API 게이트웨이
- 속도 제한 서비스
- 메타데이터 서비스
  - 어떤 저장소에서 읽고 쓸지 제어
- 스토리지 서비스
  - 초기 설계를 단순화하려면 모든 파일을 모든 데이터 센터에 복제할 수 있다.
- 원본
- 비밀 관리 서비스
  - 암호화 키 관리
- 로깅 서비스
  - 분석
  - 요금 청구


