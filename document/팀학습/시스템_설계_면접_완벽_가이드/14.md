# 14 문자메시징 앱 설계

정확히 한 번 전달(exactly-once delivery)을 고려하는 첫 번째 예시 시스템이다.  

## 14.1 요구사항

- 기능 요구사항
  - 실시간, 결과적 일관성
  - 채팅방은 2명 ~ 1,000명
  - 텍스트만 가능, UTF-8, 문자당 최대 32비트, 메시지 크기 최대 4KB
  - 안드로이드, iOS, 윈도우...
  - 전송 확인과 읽음 확인
  - 최대 10MB의 과거 메시지 조회 및 검색
  - 메시지 본문은 비공개
- 비기능 요구사항
  - 확장성: 동시 사용자 10만 명, 1분마다 4KB, 쓰기 속도 400MB/분
  - 고가용성: 99.99%
  - 고성능: P99 10초
  - 보안과 프라이버시
  - 일관성: 메시지의 엄격한 순서는 필요 없음


## 14.2 초기 구상

얼핏 보면 9장에서 설명한 알림/경보 서비스와 유사해 보인다.  


## 14.3 초기 고수준 설계

- 메시징 서비스는 각 수신자와 열린 웹소켓 연결을 유지해야 한다.
- 발신자는 각 수신자의 공개 키로 메시지를 암호화해야 한다.
- 예측 불가능한 트래픽 급증을 처리해야 한다.

기능 요구사항을 제공하고 그 외 비기능 요구사항을 최적화하기 위해 별도의 서비스를 만든다.  

- 발신자 서비스
  - 발신자로부터 메시지를 받아 수신자에게 전달
  - 메시지 서비스에 기록
- 메시지 서비스
  - 발신자와 수신자는 이 서비스에 메시지를 요청
- 연결 서비스
  - 사용자의 활성과 차단 연결을 저장하고 검색
  - 연락처에 사용자 추가
  - 메시지 차단


## 14.4 연결 서비스


### 14.4.1 연결 만들기

사용자의 연결은 사용자의 기기 또는 브라우저 쿠키나 로컬스토리지에 저장돼야 한다.  
따라서 연결 서비스는 사용자가 기기를 변경하는 경우에 대비한 이 데이터의 백업이 되거나 사용자의 여러 기기 간에 이 데이터를 동기화하는 역할을 한다.  


### 14.4.2 발신자 차단

차단은 모든 계층(클라이언트와 서버)에서 구현해야 한다.  

#### 트래픽 줄이기

서버로의 트래픽을 줄이기 위해 차단된 수신자 연결은 사용자의 기기에 저장돼야 한다.  

#### 즉시 차단/차단 해제 허용




