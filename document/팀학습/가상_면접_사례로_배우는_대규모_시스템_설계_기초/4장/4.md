# 4장 처리율 제한 장치의 설계

네트워크 시스템에서 처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치이다.  
API 요청 횟수가 제한 장치에 정의된 임계치를 넘어서면 추가로 도달한 모든 호출은 처리가 중단된다.  

처리율 제한 장치를 두면 좋은 점

- Dos 공격에 의한 자원 고갈을 방지할 수 있다.  
- 비용을 절감한다. 추가 요청에 대한 처리를 제한하면 서버를 많이 두지 않아도 되고, 우선순위가 높은 API에 더 많은 자원을 할당할 수 있다.  
- 서버 과부하를 막는다.

## 1단계 문제 이해 및 설계 범위 확정

처리율 제한 장치를 구현하는 데는 여러 가지 알고리즘을 사용할 수 있는데, 그 각각은 고유한 장단점을 갖고 있다.  
면접관과 소통하면 어떤 제한 장치를 구현해야 하는지 분명히 할 수 있다.  

## 2단계 개략적 설계안 제시 및 동의 구하기

일단 일을 너무 복잡하게 만드는 것은 피하고, 기본적인 클라이언트-서버 통신 모델을 사용하도록 하자.  

### 처리율 제한 장치는 어디에 둘 것인가?

- 클라이언트 요청은 쉽게 위변조가 가능하다.
- 처리율 제한 미들웨어를 만들어 해당 미들웨어로 하여금 API 서버로 가는 요청을 통제하도록 하는 것이다.

> 코로나 예방접종 사태

기술 스택이나, 인력, 우순 순위, 목표에 따라 처리율 제한 장치의 위치는 달라질 수 있다.  

### 처리율 제한 알고리즘

- 토큰 버킷
- 누출 버킷
- 고정 윈도 카운터
- 이동 윈도 로그
- 이동 윈도 카운터

### 개략적인 아키텍처

메모리상에서 동작하는 캐시가 바람직한데, 빠른데다 시간에 기반한 만료 정책을 지원하기 때문이다.
일례로 레디스는 처리율 제한 장치를 구현할 때 자주 사용되는 메모리 기반 저장장치이다.  

> 레디스는 싱글스레드인데, 많은 트래픽을 받을 수 있을지 의문

## 3단계 상세 설계

### 처리율 제한 규칙

### 처리율 한도 초과 트래픽의 처리

어떤 요청이 한도 제한에 걸리면 API는 HTTP 429 응답을 클라이언트에게 보낸다.  
경우에 따라서는 한도 제한에 걸린 메시지를 나중에 처리하기 위해 큐에 보관할 수도 있다.  

#### 처리율 제한 장치가 사용하는 HTTP 헤더

- X-Ratelimit-Remaining: 윈도 내에 남은 처리 가능 요청의 수
- X-Ratelimit-Limit: 매 윈도마다 클라이언트가 전송할 수 있는 요청의 수
- X-Ratelimit-Retry-After: 한도 제한에 걸리지 않으려면 몇 초 뒤에 요청을 다시 보내야 하는지 알림

### 상세 설계

### 분산 환경에서의 처리율 제한 장치의 구현

여러 대의 서버와 병렬 스레드를 지원하도록 시스템을 확장하는 것은 또 다른 문제다.  

#### 경쟁 조건

경쟁 조건 문제를 해결하는 가장 널리 알려진 해결책은 락이다.  
하지만 락은 시스템의 성능을 상당히 떨어뜨린다는 문제가 있다.  

루아 스크립트와 정렬 집합이라 불리는 레디스 자료구조를 쓰는 것이다.  

#### 동기화 이슈

동기화는 분산 환경에서 고려해야 할 또 다른 중요한 요소다.  
수백만 사용자를 지원하려면 한 대의 처리율 제한 장치 서버로는 충분하지 않을 수 있다.  
그래서 처리율 제한 장치 서버를 여러 대 두게 되면 동기화가 필요해진다.  

- 고정 세션 > 확장 가능하지도 않고 유연하지도 않음
- 레디스

#### 성능 최적화

#### 모니터링

- 체택된 처리율 제한 알고리즘이 효과적이다.
- 정의한 처리율 제한 규칙이 효과적이다.

## 4단계 마무리

- 경성(hard) : 요청의 개수는 임계치를 절대 넘어설 수 없다.
- 연성(soft) : 요청 개수는 잠시 동안은 임계치를 넘어설 수 있다.

- 다양한 계층에서의 처리율 제한
- 처리율 제한을 회피하는 방법
