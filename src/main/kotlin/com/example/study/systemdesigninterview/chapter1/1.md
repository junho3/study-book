# 1장 사용자 수에 따른 규모 확장성

### 단일 서버

1. 사용자가 도메인으로 웹사이트에 접속
2. DNS 서버에서 도메인을 IP로 반환
3. IP 주소로 Http 요청
4. 서버 응답

## 데이터베이스

### 어떤 데이터베이스를 사용할 것인가?

RDBMS vs NoSql  

NoSql이 필요한 조건  
- 아주 낮은 응답 지연시간이 요구됨  
- 다루는 데이터가 비정형이라 관계형 데이터가 아님
- 데이터를 직렬화하거나 역직렬화 할 수 있기만 하면 됨  
- 아주 많은 양의 데이터를 저장할 필요가 있음

> 보통 DBA분들이 NoSql을 좋아하진 않는 것 같음  
> NoSql을 사용해본 경험이 없음  
> AWS Aurora RDS https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/CHAP_AuroraOverview.html  

## 수직적 규모 확장 vs 수평적 규모 확장

스케일 업: 서버의 스펙을 올리는 것  
스케일 아웃: 서버의 수를 늘리는 것  

수직적 규모 확장에는 한계가 있다.  
한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법은 없다.  

수직적 규모 확장법은 장애에 대한 자동복구 방안이나 다중화 방안을 제시하지 않는다.  
서버에 장애가 발생하면 웹사이트/앱은 완전히 중단된다.  

### 로드밸런서

로드밸런서는 부하 분산 집합에 속한 웹서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.  
서버 1이 다운되면 모든 트래픽은 서버 2로 전송된다.  

### 데이터베이스 다중화

보통은 서버 사이에 주-부 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식이다.  
쓰기 연산은 마스터에서만 지원한다.  
부 데이터베이스는 주 데이터베이스로부터 그 사본을 전달받으며, 읽기 연산만을 지원한다.  

- 더 나은 성능
- 안전성: 자연 재해 등의 이유로 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존될 것이다.
- 가용성: 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 계속 서비스할 수 있게 된다.  

부 서버가 한 대 뿐인데 다운된 경우라면, 읽기 연산은 한시적으로 모두 주 데이터베이스로 전달될 것이다.  
주 데이터베이스 서버가 다운되면, 한 대의 부 데이터베이스만 있는 경우 해당 부 데이터베이스 서버가 새로운 주 서버가 될 것이며, 모든 데이터베이스 연산은 일시적으로 새로운 주 서버상에서 수행될 것이다.  

> @Transactional(readOnly = true)는 Read DB에 붙도록 설정 필요  
> DBMS Driver 버전 잘 확인 해야 함  
> Write > Read로 복제하는 텀이 있기 때문에 실시간 조회가 필요하면 Write에서 조회해야 함  

## 캐시

캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소이다.  

### 캐시 계층

캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠르다.  
읽기 주도현 캐시 전략: 먼저 캐시가 있는지 확인하고, 없으면 DB에서 데이터 조회  

> 첫 회사가 Ad tech 회사라서 캐시를 많이 다뤄봄  
> 원시적이지만, 가장 빠른 로컬 파일 캐시로 광고를 서빙하고, 크론탭과 Rsync로 주기적으로 캐시 파일을 최신화 함  

### 캐시 사용 시 유의할 점

- 캐시는 어떤 상황에 바람직한가?
- 어떤 데이터를 캐시에 두어야 하는가?
- 캐시에 보관된 데이터는 어떻게 만료되는가?
- 일관성은 어떻게 유지되는가?
- 장애에는 어떻게 대처할 것인가?
- 캐시 메모리는 얼마나 크게 잡을 것인가?
- 데이터 방출 정책은 무엇인가? LRU, LFU, FIFO

## 콘텐츠 전송 네트워크(CDN)

CDN은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다.  
이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있다.  

사용자에게 가장 가까운 CDN 서버가 정적 콘텐츠를 전달하게 된다.  
CDN 서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버에 요청하여 파일을 가져온다.  

> AWS CloudFront(CDN) 사용 시 일반적으로 TTL을 설정하여 사용  
> TTL을 0으로도 설정 가능한데, 이 경우 캐싱의 의미는 없지만 AWS 전용망을 타고 서버를 호출하는 이점을 얻을 수 있음  

### CDN 사용 시 고려해야 할 사항

- 비용
- 적절한 만료 시한 설정
- CDN 장애에 대한 대처 방안
- 콘텐츠 무효화 방법

## 무상태 웹 계층

### 상태 정보 의존적인 아키텍처

같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다.  
대부분의 로드밸런서가 이를 지원하기 위해 고정 세션이라는 기능을 제공하고 있는데, 이는 로드밸런서에 부담을 준다.  

### 무상태 아키텍처

웹 서버는 상태 정보가 필요할 경우 공유 저장소로부터 데이터를 가져온다.  
공유 저장소는 관계형 데이터베이스일 수도 있고, Memcached/Redis 같은 캐시 시스템일 수도 있으며, NoSQL일 수도 있다.  

## 데이터 센터

장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내되는데, 통상 이 절차를 지리적 라우팅이라고 부른다.  

- 트래픽 우회: 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 한다.
- 데이터 동기화: 데이터 센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면, 장애가 자동으로 복구되어 트래픽이 다른 데이터베이스로 우회된다 해도, 해당 데이터센터에는 찾는 데이터가 없을 수 있다.  
- 테스트와 배포

## 메세지 큐

메시지 큐는 메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트다.  
메시지 큐를 이용하면 서비스 또는 서버 간 결합이 느슨해져서, 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.  

> ActiveMq vs RabbitMq vs Kafka  
> inbox outbox 패턴 https://event-driven.io/en/outbox_inbox_patterns_and_delivery_guarantees_explained/  

## 로그, 메트릭 그리고 자동화

- 로그: 로그스태시, 집킨..
- 메트릭: 데이터독, 그라파나, 엘라스틱서치, 키바나..
- 자동화: 젠킨스, Github Action

## 데이터베이스의 규모 확장

### 수직적 확장

SPOF (단일 장애 지점) 문제

### 수평적 확장

샤딩은 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술을 일컫는다.  
모든 샤드는 같은 스키마를 쓰지만 샤드에 보관된 데이터 사이에는 중복이 없다.  

- 데이터의 재 샤딩: 데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때
- 유명인사 문제: 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
- 조인과 비정규화: 여러 샤드에 걸친 데이터를 조인하기가 힘들어진다.  

### 백만 사용자, 그리고 그 이상

시스템의 규모를 확장하는 것은 지속적이고 반복적인 과정이다.
