# 2장 주변 친구

근접성 서비스의 경우 사업장 주소는 정적이지만, 주변 친구 위치는 자주 바뀔 수 있기 때문이다.  

## 1단계: 문제 이해 및 설계 범위 확정

- 지리적으로 5마일 내에 있어야 하며, 이 수치는 설정 가능해야 함
- 두 사용자의 직선거리로만 가정
- 전체 10억명 중에 10% 1억명이 사용
- 사용자의 이동 이력은 보관해야 함
- 10분 이상 비활성 상태이면, 친구 목록에서 사라지도록 함
- GDPR, CCPA 같은 개인정보보호법은 생각하지 않기로 함

### 기능 요구사항

### 비기능 요구사항

- 낮은 지연 시간: 친구 위치가 빠르게 반영되야 한다.
- 안정성
- 결과적 일관성: 위치 데이터를 저장하기 위해 강한 일관성을 지원하는 데이터 저장소를 사용할 필요는 없다.

### 개략적 규모 추정


## 2단계: 개략적 설계안 제시 및 동의 구하기

위치 정보를 모든 친구에게 전송해야 하는 요구사항 때문에 HTTP 프로토콜을 사용하지 못 할 수 있다.  

### 개략적 설계안

이론적으로 사용자 근처의 모든 친구의 단말과 연결하는 P2P 방식을 생각할 수 있지만, 모바일 단말은 통신 상태가 좋지 않고, 전력도 충분하지 않다.  
공용 백엔드 서버가 중계해줘야 한다.  
동시 접속자가 천만명에 30초마다 갱신했을 때 초당 334,000번의 위치 정보 갱신을 해야하며, 큰 규모에 대응 할 수 없다.  

### 설계안

#### 로드밸런서

#### RESTful API

사용자와 친구 관리, 인증 및 기타 기능

#### 웹소켓 서버

친구 위치 정보 변경을 거의 실시간에 가깝게 처리  
각 클라이언트는 한 대의 웹소켓 연결을 지속적으로 유지한다.  

#### 레디스 위치 정보 캐시

레디스는 활성 상태 사용자의 가장 최근 위치 정보를 개시하는 데 사용한다.  
TTL 설정으로 캐시의 생명주기를 관리  

#### 사용자 데이터베이스

> Neo4j  
> https://www.en-core.com/kor/board/notice?viewMode=view&ca=&sel_search=&txt_search=&page=1&idx=98

#### 위치 이동 이력 데이터베이스

#### 레디스 펍/섭 서버

> 사용자 1이 발행하는 토픽을 구독하는 친구들은 동적으로 변할탠데, 이것을 어떻게 제어하는가?  
> 레디스 내에 엄청 많은 토픽이 필요할탠데, 어떻게 유지되는 것인가?  

> 채널톡 실시간 채팅 서버 개선 여정 - 1편 : 레디스의 'Pub/Sub'  
> 이번 실험의 주 목적은 레디스의 부하를 줄이는 것이었습니다. 하지만, 오히려 더 늘었던 것에는 레디스 Pub/Sub시스템 자체가 많은 PSUBSCRIBE 를 감당하기 어려운 구조로 되어있기 때문이었죠.  
> 그렇다고 개선된 어댑터가 모든 곳에서 성능 저하를 보여준 건 아니었습니다. 레디스에 부하를 더 줄지언정 소켓 서버가 필요한 메세지만을 전달받을 수 있도록 하여 오히려 소켓 서버의 부하는 줄일 수 있었습니다.  
> 이번 실험의 핵심은 레디스의 부하를 줄이는 것이기에 가설 자체는 틀렸지만, 소켓 서버와 레디스는 서로 상충관계에 놓여 있기에 소켓 서버에 더 많은 부하를 주는 방식이 필요하다면 충분히 고려해 볼 만한 방법이 아닐지 싶습니다.  
> 
> https://channel.io/ko/blog/real-time-chat-server-1-redis-pub-sub

#### 주기적 위치 갱신

한 사용자당 편균 400명의 친구가 있으며 10% 가량이 주변에서 온라인 상태로 가정하였으므로, 위치가 바뀔 때마다 40건씩 위치 정보 전송이 발생한다.  


### API 설계

#### 웹소켓

1. [서버 API] 주기적인 취지 정보 갱신
2. [클라이언트 API] 클라이언트가 갱신된 친구 위치를 수신하는 데 사용할 API
3. [서버 API] 웹소켓 초기화 API
4. [클라이언트 API] 새 친구 구독 API
5. [클라이언트 API] 구독 해지 API

#### HTTP 요청

1. 친구 추가/삭제
2. 사용자 정보 갱신


### 데이터 모델

#### 위치 정보 캐시

사용자ID (키) : {위도, 경도, 시각} (값)

##### 위치 정보 저장에 데이터베이스를 사용하지 않는 이유는?

- 현재 위치만 필요함
- 읽기 / 쓰기 연산이 빠름
- TTL 설정으로 사용하지 않는 값을 자동으로 제거 가능
- 레디스 서버에 장애가 발생하여, 위치 변경 내역을 놓치더라도 서비스 특성상 수용 가능

##### 위치 이동 이력 데이터베이스

카산드라는 막대한 쓰기 연산 부하를 감당할 수 있고, 수평적 규모 확장이 가능  
관계형 데이터베이스를 사용할 경우 샤딩이 필요하며, 사용자ID를 기준 삼는 샤딩이 가장 기본이다.  

> 샤딩 정책은 유명인 문제를 고민해야 함  



