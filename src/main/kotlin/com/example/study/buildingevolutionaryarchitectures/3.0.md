# CHAPTER 3 점진적 변화 엔지니어링

진화적 아키텍처는 다양한 차원에 걸쳐 점진적 변화를 유도하는 아키텍처다.  
점진적 변화란 일련의 사소한 변화를 통해 아키텍처 전체의 변화를 달성한다는 의미다.  

## 3.1 점진적 변화

마이크로서비스는 기술적 커플링을 없애고 각 서비스를 운영적으로 분리하는 무공유 아키텍처를 지향한다.  

신기능이 담긴 버전은 기존 버전을 유지하고 추가로 공개한다.  
모든 서비스가 반드시 신규 서비스로 마이그레이션할 필요는 없다.  
신버전을 사용하는 서비스는 시간이 흐를수록 생태계 안에서 점점 늘어난다.  
운영 그룹은 일정 시간 동안 서비스를 관찰하다가 라우팅 내역이 없는 서비스를 발견하면 해당 서비스를 생태계에서 자동으로 분리한다.  

> 최근에 합결제 개념 논의 과정에서 카프카 결제완료 메세지 규격을 변경해야되는 결론이 나왔음  
> 기존 토픽에 메세지 규격을 변경하면, 컨슈머쪽에서 문제가 발생하기 때문에 점진적으로 교체하는 방향으로 결정함  
> 
> approve-payment-v2라는 신규 토픽을 만들고, 결제 완료 시 기존 토픽(approve-payment)과 신규 토픽 모두 메세지를 발행  
> 신규 컨슈머는 신규 토픽을 구독하도록 작업하고, 유관 부서에 내용 공유 및 신규 토픽으로 전환 유도    
> 기존 토픽에 컨슈머 그룹이 없어지면, 메세지 발행도 중단  
> 
> 네이버의 런타임 데드 코드 분석 도구 스케빈저  
> https://github.com/naver/scavenger  

개발팀이 신규 서비스를 배포할 때, 기존 서비스를 호출하는 다른 서비스까지 강제로 업그레이드할 필요는 없어야 한다.  
따라서 아키텍트는 별점 서비스 엔드포인트를 잠시 프록시로 변경하고 서비스 요청 버전을 확인한 뒤 각각에 맞게 라우팅한다.  

> 레거시 기간계 기능을 신규 시스템으로 마이그레이션할 때도 위와 같은 방법을 사용했음  
> 프론트에서 기간계를 호출하는 것은 동일하지만, URI의 버저닝을 통해 v1인 경우에는 기존 기간계 서비스 로직을 태움  
> v2인 경우에는 신규 시스템으로 api 호출하도록 라우팅 역할만 제공  
> 문제가 발생할 경우 프론트를 롤백하여 v1을 호출하도록 변경하면 됨  
> 
> 앱은 롤백할 수 없기 때문에 백엔드에서 롤백 제어를 할 수 있도록 해야 함  


### 3.1.1 배포 파이프라인

배포 파이프라인 메커니즘은 지속적 전달 (CD) 기술에 속한다.  
지속적 통합 서버와 마찬가지로 배포 파이프라인은 변경 사항을 수신하고 일련의 검증 단계를 실행한다.  

> ADOP: 서버 내에 들어가서 수동 git pull 배포  
> 컬리: github action, Jenkins, AWS code pipeline  
> 카카오페이손해보험: Jenkins, Argocd  
> 
> 토이 프로젝트는 github action으로 PR을 생성할 때 테스트 코드와 ktlint가 돌도록 설정해놨음  

파이프라인에서 쓰일 배포 이미지를 구축함으로써 개발팀과 운영팀은 일종의 확실을 얻게 된다.  

> git 태그로 유의적 버전 x.x.x을 생성하고, 배포 이미지를 확정하는 편  

진화적 아키텍처 프로젝트는 지속적 배포를 지향한다.  
파이프라인이 세운 테스트와 검증의 장벽을 무사히 통과한 병경 사항만 지속적으로 프로덕션에 반영해야 한다.  

변경 사항을 반영할 때는 두 가지를 확인해야 한다.  
첫째, 변경 사항이 현재 프로덕션에 부정적 영향을 미치지 않도록 해야 한다.  
둘째, 변경 사항이 잘 반영되어 미래 상태 환경에 문제가 없는지 확인해야 한다.  

정기적으로 추가되는 신기능은 사용자에게 깊은 인상을 남기지 못한다.  
오히려 사용자는 전통적인 '빅뱅' 방식의 배포를 더 선호하는 경향이 있다.  

실제로 지속적 배포를 수행하는 많은 팀은 기능 토글을 활용해 신기능 운영 시점과 소비자 릴리스 시점을 분리하고 있다.  

> 카카오페이손해보험은 기능 추가 시 빅뱅에 가까운 배포를 함  
> 운영환경에 배포 후 사내 아이피로만 붙어서 테스트하는 스테이지 단계가 존재  


### 3.1.2 PenultimateWidgets의 피트니스 함수

1단계: CI 복제  

2단계: 컨테이너화 및 배포  

3단계: 원자 피트니스 함수 실행  
자동화된 확장성 테스트 및 보안 침투 테스트가 이 단계에서 실행된다.  

4단계: 전체 피트니스 함수 실행  
통합 지점을 보호하기 위한 계약 테스트와 몇 가지 확장성 테스트가 포함된다.  

5a단계: 보안 검토(수동)  

5b단계: 감사(수동)  

6단계: 배포  


### 3.1.3 자동화 빌드의 API 일관성 검증  

소비자 주도 계약은 통합 아키텍처 원자 피트니스 함수 역할을 하며 마이크로서비스 아키텍처에서 보편화된 관행이다.  

> Spring-Cloud-Contract  
> https://velog.io/@csh0034/Spring-Cloud-Contract  
> 
> MSA 환경에서 서비스와 API는 무수히 많고, 계속해서 추가/변경되므로 목킹 테스트는 한계가 있다는 점에 동의함  
> Spring-Cloud-Contract와 같이 변경에 대한 제공/공유를 자동화할 필요가 있다고 생각함  
> Spring-Cloud-Contract 도입 전까지는 각 팀과 개발자는 자신들의 개발/QA환경의 시스템을 최신화하는 식으로 대응해야할 듯  


